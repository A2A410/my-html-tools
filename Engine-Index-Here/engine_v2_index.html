<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<!-- ‚úÖ Security:  Restrict to self + GitHub API only -->
<meta http-equiv="Content-Security-Policy" 
  content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.github.com">
<title>HTML Engine Index</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Roboto',sans-serif;background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:16px;color:#333}
. container{max-height:calc(100vh - 32px);background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,. 2);overflow:hidden;display:flex;flex-direction:column}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
.header h1{font-size:24px;margin-bottom:12px;font-weight:500}
.controls{display:flex;flex-direction:column;gap:8px}
.input-group{display:flex;gap:8px;flex-wrap:wrap}
.input-group input{flex:1;min-width:200px;padding:10px;border:none;border-radius:6px;font-size:14px;background: rgba(255,255,255,. 9)}
.btn{padding:10px 16px;border:none;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;text-align:center;white-space:nowrap}
. btn-primary{background:#fff;color:#667eea}. btn-primary:active{transform:scale(. 95);background:#f0f0f0}
. btn-secondary{background: rgba(255,255,255,. 2);color:#fff;border: 1px solid rgba(255,255,255,.3)}.btn-secondary:active{background: rgba(255,255,255,. 3)}
.btn-github{background:#24292e;color:#fff;border: none}. btn-github:active{background:#1a1e22}
.status{margin-top:8px;padding:8px;background:rgba(255,255,255,.15);border-radius:6px;font-size:13px;min-height:36px;display:flex;align-items: center}
.content{flex:1;overflow-y:auto;padding:20px}
.list-item{background:#f5f5f5;padding:14px;margin-bottom:10px;border-radius:8px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.list-item:active{transform:scale(.98);background:#e0e0e0}
.list-item-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content: center;color:#fff;font-weight:700;font-size:18px;flex-shrink:0}
. list-item-text{flex:1;overflow: hidden}
.list-item-title{font-weight:500;color:#333;font-size:15px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.list-item-path{font-size:12px;color:#666;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.empty{text-align:center;padding:40px;color:#999;font-size:14px}
.loading{display:none;justify-content:center;padding:40px}
. spinner{width:40px;height:40px;border: 4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.error{color:#ff6b6b;background: rgba(255,107,107,.1);padding:12px;border-radius:6px;margin: 10px 0;font-size:13px}
.modal{display:none;position:fixed;z-index:1000;left: 0;top:0;width: 100%;height:100%;background: rgba(0,0,0,. 5);align-items:center;justify-content:center}
.modal-content{background:#fff;border-radius:12px;padding:24px;max-width:500px;margin:16px;max-height:80vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.3)}
.modal-header{font-size:20px;font-weight:700;margin-bottom:16px;color:#667eea}
. modal-section{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #eee}
.modal-section:last-child{border-bottom: none}
.modal-section h3{font-size:15px;font-weight:700;color:#333;margin-bottom:8px}
.modal-section p{font-size:14px;color:#666;line-height:1.6;margin-bottom:8px}
.modal-section code{background:#f5f5f5;padding:2px 6px;border-radius:4px;font-family: monospace;font-size:13px;color:#667eea}
.modal-close{background:#667eea;color:#fff;border:none;padding:10px 20px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;width:100%;margin-top:8px}. modal-close:active{transform:scale(.95)}
.fab-container{position:fixed;bottom: 20px;right:20px;display:flex;flex-direction:column;gap:12px;z-index:99}
.fab{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;font-size:24px;box-shadow:0 4px 12px rgba(0,0,0,.3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}. fab:active{transform:scale(. 9)}.fab.secondary{background:#24292e;font-size:20px}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üóÇÔ∏è HTML Engine Index</h1>
<div class="controls">
<div class="input-group">
<input type="text" id="repoInput" placeholder="owner/repo (e.g., octocat/Hello-World)" inputmode="text" spellcheck="false">
<button class="btn btn-primary" onclick="scan()">Scan</button>
</div>
<div class="input-group">
<input type="url" id="baseUrlInput" placeholder="Optional: Custom base URL">
</div>
<div class="input-group">
<button class="btn btn-secondary" onclick="autoDetect()">Auto Detect</button>
<button class="btn btn-secondary" onclick="refresh()">Refresh</button>
<button class="btn btn-secondary" onclick="clearData()">Clear</button>
<button class="btn btn-secondary" onclick="showHelp()">‚ÑπÔ∏è Help</button>
</div>
<div class="input-group">
<button class="btn btn-github" id="repoLink" onclick="openRepo()" style="display:none">üîó Open on GitHub</button>
</div>
<div class="status" id="status" role="status" aria-live="polite">Ready to scan ‚Ä¢ Detects from current URL or manual input</div>
</div>
</div>
<div class="content" id="content">
<div class="loading" id="loading"><div class="spinner"></div></div>
<div class="empty" id="empty">Enter a GitHub repo or use auto-detect to start</div>
<div id="list"></div>
</div>
</div>

<div class="fab-container">
<button class="fab secondary" onclick="showHelp()" title="Help">‚ÑπÔ∏è</button>
<button class="fab" onclick="scrollToTop()" title="Scroll to top">‚Üë</button>
</div>

<div class="modal" id="helpModal" onclick="if(event.target===this)closeHelp()">
<div class="modal-content">
<div class="modal-header">üìñ How to Use</div>
<div class="modal-section">
<h3>What is this?</h3>
<p>An automatic HTML file indexer for GitHub repositories. Drop this file as <code>index.html</code> in your GitHub Pages repo to auto-generate a discoverable index of all HTML files.</p>
</div>
<div class="modal-section">
<h3>Auto-Detect Mode</h3>
<p>If served on GitHub Pages (e.g., <code>user.github.io/repo/</code>), click <code>Auto Detect</code> to auto-scan your repo. </p>
</div>
<div class="modal-section">
<h3>Manual Repo Input</h3>
<p>Enter any GitHub repo in <code>owner/repo</code> format to scan it. </p>
<p>Example: <code>octocat/Hello-World</code></p>
</div>
<div class="modal-section">
<h3>Custom Base URL</h3>
<p>If HTML files are deployed to a custom domain or subdirectory, enter the base URL.</p>
<p>Example: <code>https://mydomain.com</code> or <code>https://example.com/subpath</code></p>
<p>The index will construct file URLs as:  <code>base-url/path/to/file.html</code></p>
</div>
<button class="modal-close" onclick="closeHelp()">Got it! </button>
</div>
</div>

<script>
// ================== CONFIGURATION ==================
const REPO_PATTERN = /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,38})?\/[a-zA-Z0-9][a-zA-Z0-9\-_.]*/;
const URL_PATTERN = /^https?:\/\//i;
const LS_KEY = 'engine_index_data_v1';
const LS_REPO = 'engine_index_repo_v1';
const LS_BASE = 'engine_index_base_v1';

let currentRepo = '';
let lastRequestTime = 0;

// ================== UTILITIES ==================

// ‚úÖ SECURITY: Safely sanitize HTML strings
function sanitizeHTML(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ‚úÖ SECURITY: Validate repo format (owner/repo)
function isValidRepo(repo) {
  return REPO_PATTERN.test(repo. trim());
}

// ‚úÖ SECURITY: Validate URL format
function isValidURL(url) {
  try {
    new URL(url);
    return URL_PATTERN.test(url);
  } catch {
    return false;
  }
}

// ‚úÖ SECURITY:  Rate limit requests (min 500ms between scans)
function canRequest() {
  const now = Date.now();
  if (now - lastRequestTime < 500) {
    return false;
  }
  lastRequestTime = now;
  return true;
}

// Get DOM element
const $ = (id) => document.getElementById(id);

// Set status message
function setStatus(msg, type = 'info') {
  const s = $('status');
  s.textContent = msg;
  s. style.background = type === 'error' ?  'rgba(255,107,107,. 3)' 
                     : type === 'success' ? 'rgba(76,175,80,.3)' 
                     : 'rgba(255,255,255,.15)';
}

// ================== MODAL FUNCTIONS ==================

function showHelp() {
  $('helpModal').style.display = 'flex';
}

function closeHelp() {
  $('helpModal').style.display = 'none';
}

function scrollToTop() {
  $('content').scrollTo({ top: 0, behavior:  'smooth' });
}

function openRepo() {
  if (currentRepo && isValidRepo(currentRepo)) {
    window.open(`https://github.com/${currentRepo}`, '_blank', 'noopener,noreferrer');
  }
}

// ================== AUTO-DETECT ==================

function autoDetect() {
  const hostname = window.location.hostname;
  const pathname = window.location.pathname;

  // Check for GitHub Pages pattern:  username. github.io
  const match = hostname.match(/^([a-zA-Z0-9\-]+)\.github\.io$/);
  if (match) {
    const user = match[1];
    const pathParts = pathname.split('/').filter(p => p);
    const repo = pathParts[0] || user;
    const repoString = `${user}/${repo}`;

    if (isValidRepo(repoString)) {
      $('repoInput').value = repoString;
      const baseUrl = `https://${hostname}/${repo}`;
      localStorage.setItem(LS_BASE, baseUrl);
      setStatus(`Auto-detected: ${sanitizeHTML(repoString)}`, 'success');
      scan();
      return;
    }
  }

  setStatus('Not on GitHub Pages.  Enter repo manually (owner/repo).', 'error');
}

// ================== DATA MANAGEMENT ==================

function save(data, repo, baseUrl) {
  if (!isValidRepo(repo)) return;
  localStorage.setItem(LS_KEY, JSON.stringify(data));
  localStorage.setItem(LS_REPO, repo);
  if (baseUrl && isValidURL(baseUrl)) {
    localStorage.setItem(LS_BASE, baseUrl);
  }
}

function load() {
  const data = localStorage.getItem(LS_KEY);
  const repo = localStorage.getItem(LS_REPO);
  
  if (data && repo && isValidRepo(repo)) {
    $('repoInput').value = repo;
    const baseUrl = localStorage.getItem(LS_BASE);
    if (baseUrl) $('baseUrlInput').value = baseUrl;
    currentRepo = repo;
    $('repoLink').style.display = 'block';
    render(JSON.parse(data));
    setStatus(`Loaded ${JSON.parse(data).length} files from cache`, 'success');
    return true;
  }
  return false;
}

function clearData() {
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_REPO);
  localStorage.removeItem(LS_BASE);
  $('repoInput').value = '';
  $('baseUrlInput').value = '';
  $('list').innerHTML = '';
  $('empty').style.display = 'block';
  $('repoLink').style.display = 'none';
  currentRepo = '';
  setStatus('Cache cleared', 'success');
}

function refresh() {
  const repo = $('repoInput').value. trim();
  if (repo) scan();
  else autoDetect();
}

// ================== MAIN SCAN LOGIC ==================

async function scan() {
  const repo = $('repoInput').value.trim();
  
  if (!repo) {
    setStatus('Please enter a repository (owner/repo)', 'error');
    return;
  }

  if (!isValidRepo(repo)) {
    setStatus('Invalid format. Use: owner/repo', 'error');
    return;
  }

  if (! canRequest()) {
    setStatus('Please wait before scanning again', 'error');
    return;
  }

  const customBase = $('baseUrlInput').value.trim();
  if (customBase && !isValidURL(customBase)) {
    setStatus('Invalid base URL format', 'error');
    return;
  }

  if (customBase) {
    localStorage.setItem(LS_BASE, customBase);
  }

  currentRepo = repo;
  $('repoLink').style.display = 'block';
  $('loading').style.display = 'flex';
  $('empty').style.display = 'none';
  $('list').innerHTML = '';
  setStatus(`üîç Scanning ${sanitizeHTML(repo)}...`);

  try {
    const htmlFiles = await fetchRepoFiles(repo);
    
    if (htmlFiles.length === 0) {
      $('empty').style.display = 'block';
      $('empty').textContent = 'No HTML files found in this repository';
      setStatus(`No HTML files found in ${sanitizeHTML(repo)}`, 'error');
    } else {
      render(htmlFiles);
      const baseUrl = customBase || localStorage.getItem(LS_BASE) 
                    || `https://${repo.split('/')[0]}.github.io/${repo. split('/')[1]}`;
      save(htmlFiles, repo, baseUrl);
      setStatus(`‚úì Found ${htmlFiles.length} HTML files in ${sanitizeHTML(repo)}`, 'success');
    }
  } catch (error) {
    $('empty').style.display = 'block';
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error';
    errorDiv.textContent = `Error: ${sanitizeHTML(error.message)}`;
    $('empty').innerHTML = '';
    $('empty').appendChild(errorDiv);
    setStatus(`Failed to scan ${sanitizeHTML(repo)}`, 'error');
  } finally {
    $('loading').style.display = 'none';
  }
}

// ================== GITHUB API ==================

async function fetchRepoFiles(repo) {
  const [owner, repoName] = repo.split('/');
  if (!owner || !repoName) throw new Error('Invalid repo format');

  let branch = 'main';
  let apiUrl = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repoName)}/git/trees/${branch}?recursive=1`;
  
  let response = await fetch(apiUrl);

  // Fallback to master branch
  if (response.status === 404) {
    branch = 'master';
    apiUrl = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repoName)}/git/trees/${branch}? recursive=1`;
    response = await fetch(apiUrl);
  }

  if (!response.ok) {
    throw new Error(`Repository not found or not accessible (${response.status})`);
  }

  const data = await response.json();
  if (!data.tree) throw new Error('Invalid GitHub API response');

  return parseFiles(data.tree, owner, repoName);
}

function parseFiles(tree, owner, repo) {
  const baseUrl = localStorage.getItem(LS_BASE) || `https://${owner}.github.io/${repo}`;

  return tree
    .filter(f => f.type === 'blob' && f.path.endsWith('.html'))
    .map(f => ({
      path: f.path,
      name: f.path.split('/').pop(),
      url: `${baseUrl}/${f.path}`,
      githubUrl: `https://github.com/${owner}/${repo}/blob/${branch}/${f.path}`
    }))
    .sort((a, b) => a.path.localeCompare(b. path));
}

// ================== RENDERING ==================

function render(files) {
  const list = $('list');
  list.innerHTML = '';

  files.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.style.cursor = 'pointer';
    
    // ‚úÖ SECURITY: Validate URL before opening
    div.onclick = () => {
      if (isValidURL(file.url)) {
        window.open(file.url, '_blank', 'noopener,noreferrer');
      }
    };

    // Create icon element
    const icon = document.createElement('div');
    icon.className = 'list-item-icon';
    icon.textContent = String(index + 1);

    // Create text container
    const textContainer = document. createElement('div');
    textContainer.className = 'list-item-text';

    // Create title (filename)
    const title = document. createElement('div');
    title.className = 'list-item-title';
    title.textContent = file.name;

    // Create path
    const path = document.createElement('div');
    path.className = 'list-item-path';
    path.textContent = file.path;

    textContainer.appendChild(title);
    textContainer.appendChild(path);
    div.appendChild(icon);
    div.appendChild(textContainer);
    list.appendChild(div);
  });

  $('empty').style.display = 'none';
}

// ================== INITIALIZATION ==================

window.addEventListener('load', () => {
  if (! load()) {
    // Auto-detect if on GitHub Pages
    if (window.location.hostname.includes('github.io')) {
      setTimeout(autoDetect, 100);
    }
  }
});
</script>
</body>
</html>