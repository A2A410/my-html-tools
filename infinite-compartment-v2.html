<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Infinite Compartment v2</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Roboto',sans-serif;background:#121212;color:#e0e0e0;overflow:hidden;height:100vh;touch-action:none}
.container{height:100vh;display:flex;flex-direction:column;position:relative}
.header{background:#1e1e1e;padding:12px 16px;box-shadow:0 2px 4px rgba(0,0,0,.3);display:flex;justify-content:space-between;align-items:center;z-index:1000}
.header h1{font-size:18px;font-weight:500}
.btn{background:#bb86fc;color:#000;border:none;padding:8px 16px;border-radius:4px;font-size:14px;cursor:pointer;transition:background .2s}
.btn:active{background:#9965f4}
.btn-secondary{background:#03dac6;color:#000}
.btn-secondary:active{background:#00c4b4}
.btn-danger{background:#cf6679;color:#fff}
.btn-danger:active{background:#b85566}
.main{flex:1;overflow-y:auto;overflow-x:hidden;padding:16px;-webkit-overflow-scrolling:touch;position:relative}
.layer-header{background:#2c2c2c;padding:12px;border-radius:8px 8px 0 0;margin-top:16px;display:flex;justify-content:space-between;align-items:center}
.layer-title{font-size:16px;font-weight:500}
.compartment-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;background:#1e1e1e;padding:12px;border-radius:0 0 8px 8px}
.compartment{background:#2c2c2c;border-radius:8px;min-height:120px;display:flex;flex-direction:column;position:relative;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.2)}
.compartment-content{flex:1;padding:12px;overflow-y:auto;font-size:14px;line-height:1.5}
.compartment-actions{display:flex;gap:8px;padding:8px;background:#1e1e1e;border-top:1px solid #3c3c3c}
.compartment-actions button{flex:1;padding:8px;font-size:12px}
.text-input{width:100%;min-height:100px;background:#2c2c2c;color:#e0e0e0;border:1px solid #bb86fc;border-radius:4px;padding:12px;font-size:14px;font-family:inherit;resize:vertical}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);z-index:2000;justify-content:center;align-items:center;padding:16px}
.modal.active{display:flex}
.modal-content{background:#1e1e1e;border-radius:8px;width:100%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 8px 16px rgba(0,0,0,.4)}
.modal-header{background:#2c2c2c;padding:16px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:16px}
.modal-footer{padding:16px;display:flex;gap:8px;justify-content:flex-end}
.breadcrumb{background:#2c2c2c;padding:8px 16px;margin-bottom:8px;border-radius:4px;font-size:12px;color:#bb86fc;overflow-x:auto;white-space:nowrap}
.empty-state{text-align:center;padding:40px 20px;color:#757575}
.settings-panel{display:none;position:fixed;top:0;right:0;bottom:0;width:300px;background:#1e1e1e;box-shadow:-2px 0 8px rgba(0,0,0,.3);z-index:1500;transform:translateX(100%);transition:transform .3s;overflow-y:auto}
.settings-panel.active{display:flex;transform:translateX(0)}
.settings-header{background:#2c2c2c;padding:16px;display:flex;justify-content:space-between;align-items:center}
.settings-section{padding:16px;border-bottom:1px solid #3c3c3c}
.settings-label{font-size:14px;margin-bottom:8px;color:#bb86fc}
.debug-view{background:#000;color:#0f0;font-family:monospace;font-size:11px;padding:8px;max-height:200px;overflow-y:auto;border-radius:4px;white-space:pre-wrap;word-break:break-all}
.changelog{background:#1a1a1a;padding:12px;border-radius:4px;margin-top:8px;max-height:300px;overflow-y:auto}
.changelog-item{font-size:12px;padding:4px 0;border-bottom:1px solid #2c2c2c}
.changelog-add{color:#4caf50}.changelog-remove{color:#f44336}.changelog-fix{color:#2196f3}.changelog-change{color:#ff9800}
.loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:4px solid #3c3c3c;border-top-color:#bb86fc;border-radius:50%;animation:spin 1s linear infinite;z-index:100}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
.layer-loader{display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(18,18,18,.95);justify-content:center;align-items:center;z-index:50}
.layer-loader.active{display:flex}
.comp-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:24px;border:3px solid #3c3c3c;border-top-color:#03dac6;border-radius:50%;animation:spin .8s linear infinite}
.comp-loading{pointer-events:none;opacity:.6}
.select-input{width:100%;background:#2c2c2c;color:#e0e0e0;border:1px solid #3c3c3c;border-radius:4px;padding:8px;font-size:14px}
.checkbox-wrapper{display:flex;align-items:center;gap:8px;margin:8px 0}
.checkbox-input{width:20px;height:20px;cursor:pointer}
.clone-window{position:fixed;background:#1e1e1e;border-radius:8px;box-shadow:0 8px 16px rgba(0,0,0,.5);z-index:1400;display:none;flex-direction:column;max-width:90vw;max-height:80vh}
.clone-window.active{display:flex}
.clone-header{background:#2c2c2c;padding:12px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center;cursor:move}
.clone-body{flex:1;overflow-y:auto;padding:12px}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>Infinite Compartment v2</h1>
<div style="display:flex;gap:8px">
<button class="btn btn-secondary" onclick="app.refresh()">‚Üª</button>
<button class="btn" onclick="app.toggleSettings()">‚öô</button>
</div>
</div>
<div class="main" id="main">
<div class="layer-loader active" id="mainLoader">
<div class="loader"></div>
</div>
</div>
</div>

<div class="modal" id="textModal">
<div class="modal-content">
<div class="modal-header">
<h3>Edit Text</h3>
<button class="btn btn-danger" onclick="app.closeModal()">‚úï</button>
</div>
<div class="modal-body">
<textarea class="text-input" id="textInput"></textarea>
</div>
<div class="modal-footer">
<button class="btn" onclick="app.saveText()">Save</button>
</div>
</div>
</div>

<div class="settings-panel" id="settingsPanel">
<div class="settings-header">
<h3>Settings</h3>
<button class="btn btn-danger" onclick="app.toggleSettings()">‚úï</button>
</div>
<div class="settings-section">
<div class="settings-label">Layer Method</div>
<select class="select-input" id="layerMethod" onchange="app.saveSettings()">
<option value="reuse">Reuse - Minimal (swap data)</option>
<option value="clone">Clone - Stack windows</option>
<option value="clone2">Clone2 - Destroy on close</option>
</select>
</div>
<div class="settings-section">
<div class="settings-label">Safety Pin</div>
<div class="checkbox-wrapper">
<input type="checkbox" class="checkbox-input" id="safetyPin" onchange="app.saveSettings()">
<label>Enable corruption detection</label>
</div>
<div style="font-size:12px;color:#757575;margin-top:8px">Monitors load health with 30s/1m30s/2m checkpoints. Wipes corrupt data after failed launches.</div>
</div>
<div class="settings-section">
<div class="settings-label">Heatmap Caching</div>
<div class="checkbox-wrapper">
<input type="checkbox" class="checkbox-input" id="heatmapCache" onchange="app.saveSettings()">
<label>Preload frequent paths</label>
</div>
<div style="font-size:12px;color:#757575;margin-top:8px">Tracks most visited compartments and preloads at startup.</div>
</div>
<div class="settings-section">
<div class="settings-label">Debug View</div>
<div class="debug-view" id="debugView">~DBG:INIT~</div>
</div>
<div class="settings-section">
<div class="settings-label">Changelog</div>
<div class="changelog" id="changelog"></div>
</div>
<div class="settings-section">
<button class="btn btn-danger" style="width:100%" onclick="app.clearAll()">Clear All Data</button>
</div>
</div>

<div id="cloneContainer"></div>

<script>
const app={
data:{layers:[]},currPath:[],currComp:null,clones:[],cloneId:0,
settings:{layerMethod:'reuse',safetyPin:false,heatmapCache:false},
heatmap:{},
init(){
this.log('~SYS:BOOT~');
this.loadSettings();
this.checkSafetyPin();
this.load();
setTimeout(()=>{
this.hideMainLoader();
if(this.settings.heatmapCache)this.preloadHeatmap();
this.render();
this.log('~SYS:RDY~');
this.startSafetyPinTimer();
},500);
},
log(msg){
const d=document.getElementById('debugView');
if(d){
const t=new Date().toLocaleTimeString();
d.textContent+=`\n[${t}]${msg}`;
d.scrollTop=d.scrollHeight;
}
},
changelog(type,msg){
const cl=document.getElementById('changelog');
if(!cl)return;
const colors={ADD:'changelog-add',RMV:'changelog-remove',FIX:'changelog-fix',CHG:'changelog-change'};
const div=document.createElement('div');
div.className=`changelog-item ${colors[type]||''}`;
div.textContent=`[${type}]${msg}`;
cl.insertBefore(div,cl.firstChild);
},
loadSettings(){
try{
const s=localStorage.getItem('infiniteComp_settings');
if(s){
this.settings=JSON.parse(s);
this.log('~SET:LD~');
}
document.getElementById('layerMethod').value=this.settings.layerMethod||'reuse';
document.getElementById('safetyPin').checked=this.settings.safetyPin||false;
document.getElementById('heatmapCache').checked=this.settings.heatmapCache||false;
}catch(e){
this.log('~SET:ERR~'+e.message);
}
},
saveSettings(){
this.settings.layerMethod=document.getElementById('layerMethod').value;
this.settings.safetyPin=document.getElementById('safetyPin').checked;
this.settings.heatmapCache=document.getElementById('heatmapCache').checked;
localStorage.setItem('infiniteComp_settings',JSON.stringify(this.settings));
this.log('~SET:SV~'+this.settings.layerMethod);
this.changelog('CHG','~SET:UPD~');
},
checkSafetyPin(){
if(!this.settings.safetyPin)return;
this.log('~SFTY:CHK~');
const now=Date.now();
const stamps=JSON.parse(localStorage.getItem('infiniteComp_safety')||'{"s1":0,"s2":0,"s3":0,"fails":0}');
const lastLaunch=stamps.s1;
if(lastLaunch&&(now-lastLaunch)<120000){
if(!stamps.s3&&stamps.fails>=3){
this.log('~SFTY:WIPE3~');
this.wipeData();
return;
}
if(!stamps.s2&&stamps.fails>=2){
this.log('~SFTY:WIPE2~');
this.wipeData();
return;
}
if(!stamps.s1){
this.log('~SFTY:WIPE1~');
this.wipeData();
return;
}
stamps.fails++;
}else{
stamps.fails=0;
}
stamps.s1=now;
stamps.s2=0;
stamps.s3=0;
localStorage.setItem('infiniteComp_safety',JSON.stringify(stamps));
this.log('~SFTY:S1~');
},
startSafetyPinTimer(){
if(!this.settings.safetyPin)return;
setTimeout(()=>{
const stamps=JSON.parse(localStorage.getItem('infiniteComp_safety')||'{}');
stamps.s2=Date.now();
localStorage.setItem('infiniteComp_safety',JSON.stringify(stamps));
this.log('~SFTY:S2~');
},30000);
setTimeout(()=>{
const stamps=JSON.parse(localStorage.getItem('infiniteComp_safety')||'{}');
stamps.s3=Date.now();
stamps.fails=0;
localStorage.setItem('infiniteComp_safety',JSON.stringify(stamps));
this.log('~SFTY:S3~');
},90000);
},
wipeData(){
localStorage.removeItem('infiniteComp');
localStorage.removeItem('infiniteComp_heatmap');
this.changelog('FIX','~SFTY:AUTOWIPE~');
this.log('~SFTY:WIPED~');
},
load(){
this.log('~LD:START~');
try{
const stored=localStorage.getItem('infiniteComp');
if(stored){
this.data=JSON.parse(stored);
this.log('~LD:OK~');
}else{
this.data={layers:this.createBaseLayer()};
this.save();
this.changelog('ADD','~L0:6COMP~');
this.log('~LD:NEW~');
}
const hm=localStorage.getItem('infiniteComp_heatmap');
if(hm)this.heatmap=JSON.parse(hm);
}catch(e){
this.log('~LD:ERR~'+e.message);
this.data={layers:this.createBaseLayer()};
}
},
save(){
try{
localStorage.setItem('infiniteComp',JSON.stringify(this.data));
this.log('~SV:OK~');
}catch(e){
this.log('~SV:ERR~'+e.message);
}
},
createBaseLayer(){
const comps=[];
for(let i=0;i<6;i++){
comps.push({id:Date.now()+i,type:'empty',content:'',layers:null});
}
return comps;
},
showMainLoader(){
const loader=document.getElementById('mainLoader');
if(loader)loader.classList.add('active');
},
hideMainLoader(){
const loader=document.getElementById('mainLoader');
if(loader)loader.classList.remove('active');
},
showCompLoader(compEl){
if(!compEl)return;
compEl.classList.add('comp-loading');
const loader=document.createElement('div');
loader.className='comp-loader';
compEl.appendChild(loader);
return loader;
},
hideCompLoader(compEl,loader){
if(compEl)compEl.classList.remove('comp-loading');
if(loader&&loader.parentNode)loader.parentNode.removeChild(loader);
},
preloadHeatmap(){
const sorted=Object.keys(this.heatmap).sort((a,b)=>this.heatmap[b]-this.heatmap[a]);
if(sorted.length>0){
const topPath=sorted[0];
this.log('~HEAT:PRELD~'+topPath);
}
},
trackHeatmap(path){
if(!this.settings.heatmapCache)return;
const key=path.join(',');
this.heatmap[key]=(this.heatmap[key]||0)+1;
localStorage.setItem('infiniteComp_heatmap',JSON.stringify(this.heatmap));
this.log('~HEAT:TRK~'+key);
},
render(){
this.log('~RND:START~');
const main=document.getElementById('main');
const loader=document.getElementById('mainLoader');
main.innerHTML='';
if(loader)main.appendChild(loader);
if(this.currPath.length===0){
this.renderLayer(this.data.layers,main,[]);
}else{
const layer=this.getLayerByPath(this.currPath);
if(layer){
const breadcrumb=document.createElement('div');
breadcrumb.className='breadcrumb';
breadcrumb.innerHTML=`Root${this.currPath.map((p,i)=>`&gt;L${i+1}C${p+1}`).join('')}`;
main.appendChild(breadcrumb);
const backBtn=document.createElement('button');
backBtn.className='btn';
backBtn.textContent='‚Üê Back';
backBtn.onclick=()=>this.navigateBack();
main.appendChild(backBtn);
this.renderLayer(layer,main,this.currPath);
}
}
this.log('~RND:DONE~');
},
renderLayer(comps,container,path){
const layerDiv=document.createElement('div');
const header=document.createElement('div');
header.className='layer-header';
header.innerHTML=`<div class="layer-title">Layer ${path.length} (${comps.length} compartments)</div>`;
layerDiv.appendChild(header);
const grid=document.createElement('div');
grid.className='compartment-grid';
comps.forEach((comp,idx)=>{
const div=document.createElement('div');
div.className='compartment';
const content=document.createElement('div');
content.className='compartment-content';
if(comp.type==='text'){
const loader=this.showCompLoader(div);
setTimeout(()=>{
content.textContent=comp.content||'(empty text)';
this.hideCompLoader(div,loader);
},100+idx*50);
}else if(comp.type==='layer'){
const loader=this.showCompLoader(div);
setTimeout(()=>{
content.innerHTML=`<div class="empty-state">üìÅ ${comp.layers?comp.layers.length:0} compartments</div>`;
this.hideCompLoader(div,loader);
},100+idx*50);
}else{
content.innerHTML='<div class="empty-state">Empty</div>';
}
div.appendChild(content);
const actions=document.createElement('div');
actions.className='compartment-actions';
if(comp.type==='empty'){
const addTextBtn=document.createElement('button');
addTextBtn.className='btn';
addTextBtn.textContent='Add Text';
addTextBtn.onclick=()=>this.addText([...path,idx]);
actions.appendChild(addTextBtn);
const addSpaceBtn=document.createElement('button');
addSpaceBtn.className='btn btn-secondary';
addSpaceBtn.textContent='Add Space';
addSpaceBtn.onclick=()=>this.addSpace([...path,idx]);
actions.appendChild(addSpaceBtn);
}else if(comp.type==='text'){
const editBtn=document.createElement('button');
editBtn.className='btn';
editBtn.textContent='Edit';
editBtn.onclick=()=>this.editText([...path,idx]);
actions.appendChild(editBtn);
const delBtn=document.createElement('button');
delBtn.className='btn btn-danger';
delBtn.textContent='Delete';
delBtn.onclick=()=>this.deleteComp([...path,idx]);
actions.appendChild(delBtn);
}else if(comp.type==='layer'){
const openBtn=document.createElement('button');
openBtn.className='btn';
openBtn.textContent='Open';
openBtn.onclick=()=>this.navigateTo([...path,idx]);
actions.appendChild(openBtn);
const delBtn=document.createElement('button');
delBtn.className='btn btn-danger';
delBtn.textContent='Delete';
delBtn.onclick=()=>this.deleteComp([...path,idx]);
actions.appendChild(delBtn);
}
div.appendChild(actions);
grid.appendChild(div);
});
layerDiv.appendChild(grid);
container.appendChild(layerDiv);
},
getLayerByPath(path){
let current=this.data.layers;
for(let i=0;i<path.length;i++){
const comp=current[path[i]];
if(!comp||!comp.layers)return null;
current=comp.layers;
}
return current;
},
getCompByPath(path){
let current=this.data.layers;
for(let i=0;i<path.length-1;i++){
const comp=current[path[i]];
if(!comp||!comp.layers)return null;
current=comp.layers;
}
return current[path[path.length-1]];
},
addText(path){
this.log('~ACT:ADDTXT~'+path.join(','));
this.currComp=path;
document.getElementById('textInput').value='';
document.getElementById('textModal').classList.add('active');
},
editText(path){
this.log('~ACT:EDTTXT~'+path.join(','));
const comp=this.getCompByPath(path);
if(comp){
this.currComp=path;
document.getElementById('textInput').value=comp.content||'';
document.getElementById('textModal').classList.add('active');
}
},
saveText(){
if(!this.currComp)return;
this.log('~ACT:SVTXT~'+this.currComp.join(','));
const val=document.getElementById('textInput').value;
const comp=this.getCompByPath(this.currComp);
if(comp){
comp.type='text';
comp.content=val;
this.changelog('CHG',`~L${this.currComp.length}C${this.currComp[this.currComp.length-1]+1}:TXT~`);
this.save();
this.closeModal();
this.render();
}
},
addSpace(path){
this.log('~ACT:ADDSPC~'+path.join(','));
const comp=this.getCompByPath(path);
if(comp){
comp.type='layer';
comp.layers=this.createBaseLayer();
this.changelog('ADD',`~L${path.length}C${path[path.length-1]+1}:6COMP~`);
this.save();
this.render();
}
},
deleteComp(path){
this.log('~ACT:DEL~'+path.join(','));
if(confirm('Delete this compartment?')){
const comp=this.getCompByPath(path);
if(comp){
comp.type='empty';
comp.content='';
comp.layers=null;
this.changelog('RMV',`~L${path.length}C${path[path.length-1]+1}~`);
this.save();
this.render();
}
}
},
navigateTo(path){
this.log('~NAV:TO~'+path.join(','));
this.trackHeatmap(path);
const method=this.settings.layerMethod;
if(method==='reuse'){
this.showMainLoader();
setTimeout(()=>{
this.currPath=path;
this.render();
this.hideMainLoader();
},200);
}else if(method==='clone'||method==='clone2'){
this.openClone(path,method==='clone2');
}
},
openClone(path,destroyOnClose){
const layer=this.getLayerByPath(path);
if(!layer)return;
const id=this.cloneId++;
const clone={id,path,destroyOnClose};
this.clones.push(clone);
const container=document.getElementById('cloneContainer');
const win=document.createElement('div');
win.className='clone-window active';
win.id=`clone${id}`;
win.style.left='5%';
win.style.top=`${50+this.clones.length*20}px`;
win.style.width='90%';
win.style.height='70vh';
const header=document.createElement('div');
header.className='clone-header';
header.innerHTML=`<div>Layer: ${path.join('>')}</div>`;
const closeBtn=document.createElement('button');
closeBtn.className='btn btn-danger';
closeBtn.textContent='‚úï';
closeBtn.onclick=()=>this.closeClone(id);
header.appendChild(closeBtn);
win.appendChild(header);
const body=document.createElement('div');
body.className='clone-body';
body.id=`cloneBody${id}`;
win.appendChild(body);
container.appendChild(win);
this.renderLayer(layer,body,path);
this.log('~CLN:OPN~'+id);
},
closeClone(id){
const clone=this.clones.find(c=>c.id===id);
if(!clone)return;
const win=document.getElementById(`clone${id}`);
if(win){
if(clone.destroyOnClose){
win.remove();
this.clones=this.clones.filter(c=>c.id!==id);
this.log('~CLN:DST~'+id);
this.changelog('RMV',`~CLN:${id}~`);
}else{
win.classList.remove('active');
this.log('~CLN:HID~'+id);
}
}
},
navigateBack(){
this.log('~NAV:BCK~');
this.showMainLoader();
setTimeout(()=>{
this.currPath.pop();
this.render();
this.hideMainLoader();
},200);
},
closeModal(){
document.getElementById('textModal').classList.remove('active');
this.currComp=null;
},
toggleSettings(){
document.getElementById('settingsPanel').classList.toggle('active');
},
refresh(){
this.log('~SYS:RFRSH~');
this.showMainLoader();
setTimeout(()=>{
this.load();
this.render();
this.hideMainLoader();
},300);
},
clearAll(){
if(confirm('Clear all data? This cannot be undone!')){
this.log('~SYS:CLR~');
localStorage.removeItem('infiniteComp');
localStorage.removeItem('infiniteComp_heatmap');
this.data={layers:this.createBaseLayer()};
this.currPath=[];
this.heatmap={};
this.save();
this.changelog('RMV','~ALL:CLEARED~');
this.render();
}
}
};
document.addEventListener('DOMContentLoaded',()=>app.init());
</script>
</body>
</html>
