<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>YT Loop Player v3</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Roboto,sans-serif;background:#121212;color:#fff;overflow-x:hidden;padding:12px}
.container{max-width:100%;margin:0 auto}
.header{background:#1e1e1e;border-radius:8px;padding:16px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.3)}
h1{font-size:20px;margin-bottom:12px;color:#bb86fc}
.input-group{display:flex;gap:8px;margin-bottom:12px}
input{flex:1;padding:12px;border:none;border-radius:4px;background:#2c2c2c;color:#fff;font-size:14px}
input:focus{outline:2px solid #bb86fc}
button{padding:12px 20px;border:none;border-radius:4px;background:#bb86fc;color:#000;font-weight:600;cursor:pointer;font-size:14px;transition:.2s}
button:active{background:#9d6fd8;transform:scale(.98)}
.btn-secondary{background:#03dac6;color:#000}
.btn-secondary:active{background:#02b8a8}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.controls button{flex:1;min-width:80px}
.switch-container{display:flex;align-items:center;justify-content:space-between;background:#1e1e1e;padding:12px 16px;border-radius:8px;margin-bottom:12px}
.switch-label{font-size:14px;font-weight:500}
.switch{position:relative;width:48px;height:24px;background:#444;border-radius:12px;cursor:pointer;transition:.3s}
.switch.active{background:#bb86fc}
.switch-thumb{position:absolute;width:20px;height:20px;background:#fff;border-radius:50%;top:2px;left:2px;transition:.3s}
.switch.active .switch-thumb{left:26px}
.player-container{background:#1e1e1e;border-radius:8px;overflow:hidden;margin-bottom:12px;transition:all .3s;position:relative}
.player-container.minimized{height:60px}
.custom-seekbar{display:none;position:absolute;bottom:0;left:0;right:0;height:60px;background:#1e1e1e;align-items:center;padding:0 16px;z-index:10}
.player-container.minimized .custom-seekbar{display:flex}
.seek-slider{-webkit-appearance:none;appearance:none;width:100%;height:6px;background:#2c2c2c;border-radius:3px;outline:none;position:relative}
.seek-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;background:#bb86fc;border-radius:50%;cursor:pointer;transition:.2s}
.seek-slider::-webkit-slider-thumb:active{width:22px;height:22px;background:#9d6fd8}
.seek-slider::-moz-range-thumb{width:18px;height:18px;background:#bb86fc;border:none;border-radius:50%;cursor:pointer;transition:.2s}
.seek-slider::-moz-range-thumb:active{width:22px;height:22px;background:#9d6fd8}
.seek-slider::-webkit-slider-runnable-track{background:linear-gradient(to right,#bb86fc var(--progress),#2c2c2c var(--progress));height:6px;border-radius:3px}
.seek-slider::-moz-range-track{background:#2c2c2c;height:6px;border-radius:3px}
.seek-slider::-moz-range-progress{background:#bb86fc;height:6px;border-radius:3px}
iframe{width:100%;height:56.25vw;max-height:400px;border:none;display:block}
.player-container.minimized iframe{height:60px;pointer-events:none}
.play-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:999;cursor:pointer}
.play-overlay.active{display:flex}
.play-btn{width:80px;height:80px;background:#bb86fc;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;transition:.2s}
.play-overlay:active .play-btn{transform:scale(.9);background:#9d6fd8}
.history{background:#1e1e1e;border-radius:8px;padding:16px}
.history-title{font-size:16px;margin-bottom:12px;color:#03dac6}
.history-list{max-height:200px;overflow-y:auto}
.history-item{background:#2c2c2c;padding:12px;margin-bottom:8px;border-radius:4px;cursor:pointer;font-size:13px;word-break:break-all;transition:.2s}
.history-item:active{background:#3c3c3c}
.history-item:last-child{margin-bottom:0}
.empty{color:#888;font-size:14px;text-align:center;padding:20px}
.status{font-size:12px;color:#888;margin-top:8px;text-align:center}
.warning{background:#3a2a00;color:#ffb347;padding:8px;border-radius:4px;font-size:12px;margin-bottom:12px;text-align:center}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:#2c2c2c}
::-webkit-scrollbar-thumb{background:#bb86fc;border-radius:4px}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üîÑ YT Loop Player v3</h1>
<div id="fileWarning" class="warning" style="display:none">‚ö†Ô∏è Serve via HTTP(S) for best results (not file://)</div>
<div class="input-group">
<input type="text" id="urlInput" placeholder="Paste YouTube URL here">
<button onclick="loadVideo()">Load</button>
</div>
<div class="controls">
<button class="btn-secondary" onclick="saveHistory()">üíæ Save</button>
<button class="btn-secondary" onclick="clearHistory()">üóëÔ∏è Clear</button>
<button onclick="refreshPage()">üîÑ Refresh</button>
</div>
<div class="status" id="status">Ready</div>
</div>

<div class="switch-container">
<span class="switch-label">Minimize to Seekbar</span>
<div class="switch" id="minimizeSwitch" onclick="toggleMinimize()">
<div class="switch-thumb"></div>
</div>
</div>

<div class="player-container" id="playerContainer">
<div id="player"></div>
<div class="custom-seekbar">
<input type="range" class="seek-slider" id="seekSlider" min="0" max="100" value="0" step="0.1">
</div>
<div class="play-overlay" id="playOverlay">
<div class="play-btn">‚ñ∂</div>
</div>
</div>

<div class="history">
<div class="history-title">üìú Recent Videos</div>
<div class="history-list" id="historyList"></div>
</div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player,history=[],minimized=false,playerState={id:null,time:0,playing:false},stateInt=null,apiReady=false,retryCount=0,seekInt=null,userSeeking=false;

// Check file protocol warning
if(window.location.protocol==='file:'){
document.getElementById('fileWarning').style.display='block';
console.warn('Running from file://. Use http://localhost for better embed support.');
}

// Extract video ID
function getVideoId(url){
const patterns=[
/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
/^([a-zA-Z0-9_-]{11})$/
];
for(let p of patterns){
const m=url.match(p);
if(m)return m[1];
}
return null;
}

// Update status
function setStatus(msg){
document.getElementById('status').textContent=msg;
}

// Show play overlay fallback
function showPlayOverlay(){
const overlay=document.getElementById('playOverlay');
overlay.classList.add('active');
overlay.onclick=()=>{
if(player){
try{
player.mute();
player.playVideo();
overlay.classList.remove('active');
setStatus('Playing (tap to unmute)');
setTimeout(()=>{
try{player.unMute()}catch(e){}
},1500);
}catch(e){
console.log('Manual play failed:',e);
}
}
};
}

// Hide play overlay
function hidePlayOverlay(){
document.getElementById('playOverlay').classList.remove('active');
}

// Save state to localStorage
function saveState(){
if(player&&player.getVideoData){
try{
const vd=player.getVideoData();
if(vd&&vd.video_id){
playerState.id=vd.video_id;
playerState.time=player.getCurrentTime()||0;
playerState.playing=player.getPlayerState()===YT.PlayerState.PLAYING;
localStorage.setItem('ytPlayerState',JSON.stringify(playerState));
}
}catch(e){}
}
}

// Load saved state
function loadState(){
const saved=localStorage.getItem('ytLoopHistory');
if(saved)history=JSON.parse(saved);
const state=localStorage.getItem('ytPlayerState');
if(state)playerState=JSON.parse(state);
renderHistory();
}

// Restore last video
function restoreVideo(){
if(!playerState.id||!apiReady)return;
setStatus('Restoring last video...');
document.getElementById('urlInput').value='https://youtu.be/'+playerState.id;
setTimeout(()=>{
loadVideo(true);
},300);
}

// YT API ready
function onYouTubeIframeAPIReady(){
apiReady=true;
loadState();
if(playerState.id)restoreVideo();
setStatus('YouTube API ready');
}

// Load video with all fixes
function loadVideo(isRestore=false){
const url=document.getElementById('urlInput').value.trim();
if(!url){alert('Enter a YouTube URL');return}
const videoId=getVideoId(url);
if(!videoId){alert('Invalid YouTube URL');return}

// Don't load if minimized - ensure visibility
if(minimized){
alert('Unminimize player before loading');
return;
}

setStatus('Loading video...');
hidePlayOverlay();

// Add to history
if(!history.includes(url)){
history.unshift(url);
if(history.length>10)history.pop();
saveHistory();
}

// Destroy old player safely
if(player){
try{
player.stopVideo();
player.destroy();
}catch(e){}
player=null;
}

// Clear container
document.getElementById('player').innerHTML='';

// Create player with all fixes
const createPlayer=()=>{
try{
const cfg={
videoId:videoId,
playerVars:{
autoplay:1,
loop:1,
playlist:videoId,
controls:1,
modestbranding:1,
rel:0,
fs:0,
iv_load_policy:3,
disablekb:0,
playsinline:1,
enablejsapi:1,
widget_referrer:window.location.href
},
events:{
onReady:e=>{
setStatus('Video loaded');
retryCount=0;

// Fix 1: Set iframe allow attribute
try{
const iframe=e.target.getIframe?e.target.getIFrame():document.querySelector('#player iframe');
if(iframe)iframe.setAttribute('allow','autoplay; encrypted-media; picture-in-picture');
}catch(err){}

// Fix 2: Mute before autoplay
try{
if(e.target&&e.target.mute)e.target.mute();

// Fix 3: Play with promise handling
const playAttempt=e.target.playVideo();
if(playAttempt&&playAttempt.catch){
playAttempt.catch(err=>{
console.log('Autoplay blocked:',err);
showPlayOverlay();
});
}

// Restore position if needed
if(isRestore&&playerState.time>1){
setTimeout(()=>{
try{e.target.seekTo(playerState.time,true)}catch(err){}
},800);
}
}catch(err){
console.log('Play error:',err);
showPlayOverlay();
}
},
onStateChange:e=>{
if(e.data===YT.PlayerState.ENDED)e.target.playVideo();
if(e.data===YT.PlayerState.PLAYING){
setStatus('Playing');
hidePlayOverlay();
}
if(e.data===YT.PlayerState.PAUSED)setStatus('Paused');
saveState();
},
onError:e=>{
const errors={
2:'Invalid video ID',
5:'HTML5 player error - retrying...',
100:'Video not found or private',
101:'Embed disabled by owner',
150:'Embed disabled by owner'
};
const msg=errors[e.data]||'Unknown error';
setStatus('Error: '+msg);
if(e.data===5&&retryCount<3){
retryCount++;
setTimeout(()=>{
setStatus('Retrying...');
loadVideo();
},2000);
}else{
alert('‚ö†Ô∏è '+msg);
hidePlayOverlay();
}
}
}
};

// Use nocookie only if not file protocol
if(window.location.protocol!=='file:'){
cfg.host='https://www.youtube-nocookie.com';
}

// Add origin only if valid
if(window.location.origin&&window.location.origin!=='null'){
cfg.playerVars.origin=window.location.origin;
}

player=new YT.Player('player',cfg);
}catch(e){
setStatus('Player init failed');
console.error(e);
}
};

// Delay for API readiness
if(apiReady){
createPlayer();
}else{
setTimeout(createPlayer,500);
}
}

// Page visibility handling
document.addEventListener('visibilitychange',()=>{
if(document.hidden){
saveState();
clearInterval(stateInt);
stopSeekbarSync();
setStatus('Tab backgrounded');
}else{
setStatus('Tab active');
if(player){
try{
const ps=player.getPlayerState();
if(playerState.playing&&ps!==YT.PlayerState.PLAYING){
setTimeout(()=>{
player.mute();
player.playVideo();
},200);
}
}catch(e){}
}
stateInt=setInterval(saveState,8000);
if(minimized)startSeekbarSync();
}
});

// Periodic state save
stateInt=setInterval(saveState,8000);

// Cleanup before unload
window.addEventListener('beforeunload',()=>{
saveState();
clearInterval(stateInt);
stopSeekbarSync();
if(player){try{player.destroy()}catch(e){}}
});

// Error recovery
window.addEventListener('error',e=>{
console.error('Page error:',e);
saveState();
});

// Toggle minimize with visibility check
function toggleMinimize(){
if(player&&!minimized){
const ps=player.getPlayerState();
if(ps===YT.PlayerState.UNSTARTED){
alert('Load a video first');
return;
}
}
minimized=!minimized;
document.getElementById('minimizeSwitch').classList.toggle('active');
document.getElementById('playerContainer').classList.toggle('minimized');

// Start/stop seekbar sync
if(minimized){
startSeekbarSync();
}else{
stopSeekbarSync();
}
}

// Save history
function saveHistory(){
localStorage.setItem('ytLoopHistory',JSON.stringify(history));
renderHistory();
setStatus('History saved');
setTimeout(()=>setStatus('Ready'),2000);
}

// Clear history
function clearHistory(){
if(confirm('Clear all history?')){
history=[];
localStorage.removeItem('ytLoopHistory');
renderHistory();
setStatus('History cleared');
}
}

// Render history
function renderHistory(){
const list=document.getElementById('historyList');
if(history.length===0){
list.innerHTML='<div class="empty">No recent videos</div>';
return;
}
list.innerHTML=history.map((url,i)=>{
const short=url.length>60?url.substring(0,60)+'...':url;
return `<div class="history-item" onclick="loadFromHistory(${i})">${short}</div>`;
}).join('');
}

// Load from history
function loadFromHistory(idx){
document.getElementById('urlInput').value=history[idx];
loadVideo();
}

// Refresh page
function refreshPage(){
saveState();
location.reload();
}

// Init
loadState();

// Seekbar setup
const seekSlider=document.getElementById('seekSlider');

// Update seekbar position from player
function updateSeekbar(){
if(player&&minimized&&!userSeeking){
try{
const current=player.getCurrentTime()||0;
const duration=player.getDuration()||1;
const percent=(current/duration)*100;
seekSlider.value=percent;
seekSlider.style.setProperty('--progress',percent+'%');
}catch(e){}
}
}

// Start polling when minimized
function startSeekbarSync(){
if(seekInt)clearInterval(seekInt);
seekInt=setInterval(updateSeekbar,100);
}

// Stop polling
function stopSeekbarSync(){
if(seekInt){
clearInterval(seekInt);
seekInt=null;
}
}

// User starts dragging
seekSlider.addEventListener('touchstart',()=>{userSeeking=true});
seekSlider.addEventListener('mousedown',()=>{userSeeking=true});

// User drags slider
seekSlider.addEventListener('input',e=>{
if(player&&minimized){
try{
const duration=player.getDuration()||1;
const seekTime=(e.target.value/100)*duration;
player.seekTo(seekTime,true);
seekSlider.style.setProperty('--progress',e.target.value+'%');
}catch(err){console.log('Seek error:',err)}
}
});

// User releases slider
seekSlider.addEventListener('touchend',()=>{userSeeking=false});
seekSlider.addEventListener('mouseup',()=>{userSeeking=false});
</script>
</body>
</html>