<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>TRER · Top Relevance Engine Resolver</title>
<style>
:root{
--bg:#0a0c10;--bg2:#111318;--bg3:#181c24;--bg4:#1e232e;
--acc:#00e5ff;--acc2:#7c4dff;--acc3:#00bfa5;
--warn:#ffab00;--err:#ff5252;--ok:#69f0ae;
--txt:#e0e6f0;--txt2:#8a95a8;--txt3:#4a5568;
--rad:8px;--rad2:12px;--rad3:16px;
--fnt:'IBM Plex Mono',monospace;
--shadow:0 2px 16px #00000080;
--glow:0 0 12px #00e5ff40;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:var(--fnt);font-size:13px;overflow-x:hidden}
body{display:flex;flex-direction:column;max-width:520px;margin:0 auto;min-height:100vh}

/* TOP BAR */
.topbar{display:flex;align-items:center;gap:8px;padding:12px 14px 0;position:sticky;top:0;z-index:100;background:var(--bg);border-bottom:1px solid #ffffff08}
.logo{font-size:11px;font-weight:700;letter-spacing:.15em;color:var(--acc);text-transform:uppercase;white-space:nowrap}
.logo span{color:var(--txt3)}
.topbar-acts{display:flex;gap:6px;margin-left:auto}
.icon-btn{width:32px;height:32px;border-radius:var(--rad);background:var(--bg3);border:1px solid #ffffff10;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--txt2);font-size:14px;transition:.15s}
.icon-btn:active{background:var(--bg4);transform:scale(.95)}
.icon-btn.active{color:var(--acc);border-color:var(--acc)40}

/* SEARCH BAR */
.searchbar{padding:12px 14px;display:flex;gap:8px;align-items:center}
.searchbar input{flex:1;background:var(--bg3);border:1px solid #ffffff15;border-radius:var(--rad2);padding:10px 14px;color:var(--txt);font-family:var(--fnt);font-size:13px;outline:none;transition:.2s}
.searchbar input:focus{border-color:var(--acc)60;box-shadow:var(--glow)}
.searchbar input::placeholder{color:var(--txt3)}
.run-btn{min-width:72px;height:40px;background:linear-gradient(135deg,var(--acc2),var(--acc));border:none;border-radius:var(--rad2);color:#000;font-family:var(--fnt);font-size:12px;font-weight:700;letter-spacing:.05em;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:6px}
.run-btn:active{opacity:.8;transform:scale(.97)}
.run-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.run-btn svg{width:14px;height:14px}

/* WAVE PROGRESS */
.wave-track{padding:0 14px 10px;display:none}
.wave-track.show{display:block}
.wave-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.wave-lbl{font-size:10px;font-weight:700;letter-spacing:.1em;min-width:58px;color:var(--txt3)}
.wave-lbl.active{color:var(--acc)}
.wave-lbl.done{color:var(--ok)}
.wave-bar{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
.wave-fill{height:100%;width:0;border-radius:2px;transition:width .4s ease;background:var(--acc)}
.wave-fill.w2{background:var(--acc2)}
.wave-fill.w3{background:var(--acc3)}
.wave-fill.done{background:var(--ok)}
.wave-stat{font-size:10px;color:var(--txt3);min-width:36px;text-align:right}
.eta-row{display:flex;justify-content:space-between;font-size:10px;color:var(--txt3);margin-bottom:4px}

/* STATUS LOG */
.status-log{padding:0 14px;margin-bottom:8px;max-height:80px;overflow-y:auto;display:none}
.status-log.show{display:block}
.status-entry{font-size:10px;color:var(--txt3);line-height:1.6;display:flex;gap:6px;align-items:flex-start}
.status-entry .ts{color:var(--txt3);opacity:.5;min-width:28px;font-size:9px}
.status-entry.ok .msg{color:var(--ok)}
.status-entry.warn .msg{color:var(--warn)}
.status-entry.err .msg{color:var(--err)}
.status-entry.info .msg{color:var(--acc)}

/* KEYWORDS CHIPS */
.keywords-section{padding:0 14px 10px;display:none}
.keywords-section.show{display:block}
.sec-lbl{font-size:9px;letter-spacing:.12em;color:var(--txt3);text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.sec-lbl::after{content:'';flex:1;height:1px;background:var(--bg4)}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;letter-spacing:.04em;border:1px solid;cursor:default;display:flex;align-items:center;gap:5px;transition:.15s}
.chip:active{transform:scale(.96)}
.chip-score{font-size:9px;opacity:.7}
.chip.kw-hi{background:#00e5ff15;border-color:#00e5ff40;color:var(--acc)}
.chip.kw-md{background:#7c4dff10;border-color:#7c4dff30;color:#b47aff}
.chip.kw-lo{background:#ffffff06;border-color:#ffffff15;color:var(--txt2)}
.chip.kw-orig{background:#00bfa515;border-color:#00bfa540;color:var(--acc3)}

/* RESULTS */
.results-section{padding:0 14px;display:none;flex:1}
.results-section.show{display:block}
.result-count{font-size:10px;color:var(--txt3);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.result-card{background:var(--bg2);border:1px solid #ffffff0a;border-radius:var(--rad2);padding:12px 14px;margin-bottom:8px;transition:.2s;cursor:pointer;display:block;text-decoration:none;color:inherit;position:relative;overflow:hidden}
.result-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--acc);opacity:0;transition:.2s}
.result-card:active{background:var(--bg3)}
.result-card:active::before{opacity:1}
.rc-rank{position:absolute;top:10px;right:12px;font-size:9px;font-weight:700;color:var(--txt3);letter-spacing:.05em}
.rc-rank.top3{color:var(--warn)}
.rc-title{font-size:12px;font-weight:600;color:var(--txt);line-height:1.4;margin-bottom:4px;padding-right:40px}
.rc-url{font-size:9px;color:var(--acc);opacity:.7;margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rc-snippet{font-size:10px;color:var(--txt2);line-height:1.5}
.rc-meta{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.rc-badge{font-size:9px;padding:2px 7px;border-radius:10px;border:1px solid;letter-spacing:.04em}
.rc-badge.waves{background:#00e5ff08;border-color:#00e5ff20;color:var(--acc)}
.rc-badge.score{background:#69f0ae08;border-color:#69f0ae20;color:var(--ok)}
.rc-badge.domain{background:#7c4dff08;border-color:#7c4dff20;color:#b47aff}

/* EMPTY / ERROR */
.empty-state{padding:40px 14px;text-align:center}
.empty-icon{font-size:36px;margin-bottom:12px;opacity:.3}
.empty-title{font-size:13px;font-weight:600;color:var(--txt2);margin-bottom:6px}
.empty-sub{font-size:11px;color:var(--txt3);line-height:1.6}

/* SETTINGS DRAWER */
.drawer-overlay{position:fixed;inset:0;background:#00000080;z-index:200;opacity:0;pointer-events:none;transition:.25s}
.drawer-overlay.open{opacity:1;pointer-events:all}
.drawer{position:fixed;bottom:0;left:50%;transform:translate(-50%,100%);width:100%;max-width:520px;background:var(--bg2);border-radius:var(--rad3) var(--rad3) 0 0;z-index:201;transition:transform .3s cubic-bezier(.4,0,.2,1);padding:0 0 32px;max-height:85vh;overflow-y:auto}
.drawer.open{transform:translate(-50%,0)}
.drawer-handle{width:36px;height:4px;background:var(--bg4);border-radius:2px;margin:10px auto 16px}
.drawer-head{padding:0 16px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #ffffff08}
.drawer-title{font-size:13px;font-weight:700;color:var(--txt);letter-spacing:.08em}
.drawer-close{width:28px;height:28px;border-radius:50%;background:var(--bg3);border:none;color:var(--txt2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px}
.drawer-body{padding:16px}
.setting-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px}
.setting-info{flex:1}
.setting-lbl{font-size:12px;font-weight:600;color:var(--txt)}
.setting-sub{font-size:10px;color:var(--txt3);margin-top:2px}
.toggle{width:40px;height:22px;border-radius:11px;background:var(--bg4);border:1px solid #ffffff15;cursor:pointer;position:relative;transition:.2s;flex-shrink:0}
.toggle.on{background:var(--acc2);border-color:var(--acc2)}
.toggle::after{content:'';width:16px;height:16px;border-radius:50%;background:#fff;position:absolute;top:2px;left:2px;transition:.2s}
.toggle.on::after{left:20px}
.num-input{width:52px;background:var(--bg3);border:1px solid #ffffff15;border-radius:var(--rad);padding:5px 8px;color:var(--txt);font-family:var(--fnt);font-size:12px;text-align:center}
.num-input:focus{outline:none;border-color:var(--acc)50}
.range-lbl{font-size:11px;color:var(--txt2);min-width:28px;text-align:right}
.setting-section{font-size:9px;letter-spacing:.15em;color:var(--txt3);text-transform:uppercase;margin:20px 0 10px;display:flex;align-items:center;gap:8px}
.setting-section::after{content:'';flex:1;height:1px;background:var(--bg4)}

/* DEBUG DRAWER */
.debug-body{padding:12px;background:var(--bg);border-radius:var(--rad);max-height:320px;overflow-y:auto;font-size:10px;line-height:1.7}
.debug-line{display:flex;gap:6px;align-items:flex-start;border-bottom:1px solid #ffffff05;padding:2px 0}
.debug-line .dl-ts{color:var(--txt3);opacity:.5;min-width:40px;font-size:9px;flex-shrink:0}
.debug-line .dl-lvl{min-width:36px;font-size:9px;font-weight:700;flex-shrink:0}
.debug-line .dl-lvl.l-log{color:var(--txt2)}
.debug-line .dl-lvl.l-info{color:var(--acc)}
.debug-line .dl-lvl.l-warn{color:var(--warn)}
.debug-line .dl-lvl.l-error{color:var(--err)}
.debug-line .dl-msg{color:var(--txt);word-break:break-all}
.debug-acts{display:flex;gap:8px;margin-bottom:10px}
.sm-btn{padding:5px 12px;border-radius:var(--rad);background:var(--bg3);border:1px solid #ffffff15;color:var(--txt2);font-family:var(--fnt);font-size:10px;cursor:pointer}
.sm-btn:active{background:var(--bg4)}

/* HISTORY DRAWER */
.hist-item{background:var(--bg3);border-radius:var(--rad);padding:10px 12px;margin-bottom:8px;cursor:pointer;border:1px solid #ffffff08;display:flex;align-items:center;gap:10px}
.hist-item:active{background:var(--bg4)}
.hist-q{font-size:12px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hist-meta{font-size:9px;color:var(--txt3)}
.hist-del{width:26px;height:26px;border-radius:50%;background:var(--bg4);border:none;color:var(--err);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}

/* RETRY TOAST */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--warn)40;border-radius:var(--rad2);padding:10px 16px;font-size:11px;color:var(--warn);display:none;z-index:300;white-space:nowrap;box-shadow:var(--shadow)}
.toast.show{display:block}

/* BOTTOM PADDING */
.bot-pad{height:20px}

/* SCROLLBAR */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}

/* LOADER PULSE */
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
.pulsing{animation:pulse 1.2s ease infinite}

/* NO-GIVE-UP HUNT BAR */
.ngu-bar{display:none;margin:0 14px 8px;background:var(--bg3);border:1px solid var(--warn)30;border-radius:var(--rad);padding:7px 12px;gap:10px;align-items:center}
.ngu-bar.show{display:flex}
.ngu-icon{font-size:13px;animation:ngu-spin 1.5s linear infinite}
@keyframes ngu-spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.ngu-text{flex:1;font-size:10px;color:var(--warn);line-height:1.4}
.ngu-attempt{font-size:9px;color:var(--txt3);text-align:right;white-space:nowrap}
.ngu-delay-bar{width:100%;height:2px;background:var(--bg4);border-radius:1px;margin-top:4px;overflow:hidden}
.ngu-delay-fill{height:100%;background:var(--warn);border-radius:1px;transition:width .5s linear}

/* CHANGELOG DRAWER */
.changelog-list{font-size:11px}
.cl-ver{padding:10px 0 6px;border-bottom:1px solid var(--bg4);margin-bottom:6px}
.cl-ver-head{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.cl-ver-num{font-weight:700;color:var(--acc);font-size:12px}
.cl-ver-date{font-size:9px;color:var(--txt3)}
.cl-diff{display:flex;gap:12px}
.cl-add{color:var(--ok);font-size:10px}
.cl-rem{color:var(--err);font-size:10px}
.cl-notes{font-size:10px;color:var(--txt2);margin-top:4px;line-height:1.6}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">TRER<span> ·</span></div>
  <div id="topStatus" style="font-size:10px;color:var(--txt3);display:none"></div>
  <div class="topbar-acts">
    <div class="icon-btn" id="btnHistory" title="History">⏱</div>
    <div class="icon-btn" id="btnSettings" title="Settings">⚙</div>
    <div class="icon-btn" id="btnRefresh" title="Refresh" onclick="location.reload()">↺</div>
  </div>
</div>

<!-- SEARCH BAR -->
<div class="searchbar">
  <input type="search" id="qInput" placeholder="Enter search query…" autocomplete="off" autocorrect="off" spellcheck="false">
  <button class="run-btn" id="runBtn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    RUN
  </button>
</div>

<!-- WAVE PROGRESS -->
<div class="wave-track" id="waveTrack">
  <div class="eta-row">
    <span id="etaLbl">Initializing…</span>
    <span id="elapsedLbl"></span>
  </div>
  <div class="wave-row">
    <span class="wave-lbl" id="w1lbl">WAVE 1</span>
    <div class="wave-bar"><div class="wave-fill" id="w1fill"></div></div>
    <span class="wave-stat" id="w1stat"></span>
  </div>
  <div class="wave-row">
    <span class="wave-lbl" id="w2lbl">WAVE 2</span>
    <div class="wave-bar"><div class="wave-fill w2" id="w2fill"></div></div>
    <span class="wave-stat" id="w2stat"></span>
  </div>
  <div class="wave-row">
    <span class="wave-lbl" id="w3lbl">WAVE 3</span>
    <div class="wave-bar"><div class="wave-fill w3" id="w3fill"></div></div>
    <span class="wave-stat" id="w3stat"></span>
  </div>
</div>

<!-- STATUS LOG -->
<div class="status-log" id="statusLog"></div>

<!-- NGU HUNT BAR -->
<div class="ngu-bar" id="nguBar">
  <span class="ngu-icon">⟳</span>
  <div style="flex:1">
    <div class="ngu-text" id="nguText">Hunting…</div>
    <div class="ngu-delay-bar"><div class="ngu-delay-fill" id="nguDelayFill" style="width:0%"></div></div>
  </div>
  <div class="ngu-attempt" id="nguAttempt"></div>
</div>

<!-- KEYWORDS -->
<div class="keywords-section" id="kwSection">
  <div class="sec-lbl">Expansion Terms</div>
  <div class="chips" id="kwChips"></div>
</div>

<!-- RESULTS -->
<div class="results-section" id="resultsSection">
  <div class="result-count" id="resultCount">
    <span></span>
    <span id="sortLbl" style="cursor:pointer;color:var(--acc);font-size:10px" id="sortToggle">↓ relevance</span>
  </div>
  <div id="resultsList"></div>
</div>

<!-- EMPTY STATE -->
<div class="empty-state" id="emptyState">
  <div class="empty-icon">⌬</div>
  <div class="empty-title">Top Relevance Engine Resolver</div>
  <div class="empty-sub">3-wave semantic search expansion.<br>Type a query and press RUN.</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<div class="bot-pad"></div>

<!-- SETTINGS DRAWER -->
<div class="drawer-overlay" id="settingsOverlay"></div>
<div class="drawer" id="settingsDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-head">
    <span class="drawer-title">SETTINGS</span>
    <button class="drawer-close" id="settingsClose">✕</button>
  </div>
  <div class="drawer-body">
    <div class="setting-section">Search</div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Max expansion terms</div>
        <div class="setting-sub">W1 output keywords (5–10)</div>
      </div>
      <input class="num-input" id="cfgMaxKw" type="number" min="5" max="10" value="8">
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Results per keyword</div>
        <div class="setting-sub">W2 fetch count (1–5)</div>
      </div>
      <input class="num-input" id="cfgResPerKw" type="number" min="1" max="5" value="3">
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Final top results</div>
        <div class="setting-sub">W3 output (5–20)</div>
      </div>
      <input class="num-input" id="cfgTopN" type="number" min="5" max="20" value="10">
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Anti-SEO filter</div>
        <div class="setting-sub">Penalize commercial/spam results</div>
      </div>
      <div class="toggle on" id="cfgAntiSeo"></div>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Domain diversity</div>
        <div class="setting-sub">Avoid same-domain clustering</div>
      </div>
      <div class="toggle on" id="cfgDiversity"></div>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Auto retry on error</div>
        <div class="setting-sub">Up to 3 retries with backoff</div>
      </div>
      <div class="toggle on" id="cfgRetry"></div>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">No-Give-Up mode</div>
        <div class="setting-sub">Loop forever until success (0–10s delay)</div>
      </div>
      <div class="toggle" id="cfgNgu"></div>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Request delay (ms)</div>
        <div class="setting-sub">Throttle between queries</div>
      </div>
      <input class="num-input" id="cfgDelay" type="number" min="200" max="3000" step="100" value="600">
    </div>

    <div class="setting-section">System</div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Changelog</div>
        <div class="setting-sub">View version history</div>
      </div>
      <button class="sm-btn" id="openChangelog">VIEW</button>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Debug console</div>
        <div class="setting-sub">Runtime log viewer</div>
      </div>
      <button class="sm-btn" id="openDebug">OPEN</button>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-lbl">Clear history</div>
        <div class="setting-sub">Remove all saved searches</div>
      </div>
      <button class="sm-btn" id="clearHistory">CLEAR</button>
    </div>

    <div style="text-align:center;padding-top:16px">
      <span style="font-size:9px;color:var(--txt3)">TRER v1.2 · Three-Wave Semantic Resolver</span>
    </div>
  </div>
</div>

<!-- HISTORY DRAWER -->
<div class="drawer-overlay" id="historyOverlay"></div>
<div class="drawer" id="historyDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-head">
    <span class="drawer-title">HISTORY</span>
    <button class="drawer-close" id="historyClose">✕</button>
  </div>
  <div class="drawer-body" id="historyBody">
    <div class="empty-state" style="padding:20px 0">
      <div class="empty-icon">⏱</div>
      <div class="empty-sub">No searches yet</div>
    </div>
  </div>
</div>

<!-- DEBUG DRAWER -->
<div class="drawer-overlay" id="debugOverlay"></div>
<div class="drawer" id="debugDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-head">
    <span class="drawer-title">DEBUG CONSOLE</span>
    <button class="drawer-close" id="debugClose">✕</button>
  </div>
  <div class="drawer-body">
    <div class="debug-acts">
      <button class="sm-btn" id="clearDebug">CLEAR</button>
      <button class="sm-btn" id="exportDebug">EXPORT</button>
      <span style="font-size:9px;color:var(--txt3);margin-left:auto;align-self:center" id="debugCount">0 lines</span>
    </div>
    <div class="debug-body" id="debugBody"></div>
  </div>
</div>

<!-- CHANGELOG DRAWER -->
<div class="drawer-overlay" id="changelogOverlay"></div>
<div class="drawer" id="changelogDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-head">
    <span class="drawer-title">CHANGELOG</span>
    <button class="drawer-close" id="changelogClose">✕</button>
  </div>
  <div class="drawer-body">
    <div class="changelog-list" id="changelogList"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
// TRER · Top Relevance Engine Resolver · v1.0
// Three-Wave Semantic Search Expansion
// ═══════════════════════════════════════════════════════════

const VER='1.2',VER_DATE='2026-02-17';

// ─── CHANGELOG ─────────────────────────────────────────────
const CHANGELOG=[
  {v:'1.2',date:VER_DATE,add:'+187',rem:'-12',notes:'No-Give-Up mode: infinite loop with adaptive 0–10s delay. Self-URL relay proxy. JSONP DDG instant. Direct fetch attempt. Per-run operation IDs prevent stale loop collisions. NGU hunt bar UI.'},
  {v:'1.0',date:VER_DATE,add:'+1842',rem:'-0',notes:'Initial release. 3-wave DDG expansion, anti-SEO scoring, domain diversity, debug console, history, settings.'}
];

// ─── CONFIG ────────────────────────────────────────────────
const CFG_KEY='trer_cfg_v1',HIST_KEY='trer_hist_v1';
let cfg={maxKw:8,resPerKw:3,topN:10,antiSeo:true,diversity:true,retry:true,delay:600,ngu:false};
let histArr=[];
let running=false,abortFlag=false;
let sortMode='relevance';
let lastResults=[];
let elapsed=0,elapsedTimer=null;
// Per-run ID prevents stale NGU loops from writing into new runs
let runOpId=0;

// ─── DEBUG ──────────────────────────────────────────────────
const dbLines=[];
function dbg(lvl,msg){
  const ts=new Date().toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  dbLines.push({ts,lvl,msg:String(msg)});
  const b=document.getElementById('debugBody');
  const l=document.createElement('div');
  l.className='debug-line';
  l.innerHTML=`<span class="dl-ts">${ts}</span><span class="dl-lvl l-${lvl}">${lvl.toUpperCase()}</span><span class="dl-msg">${escHtml(String(msg))}</span>`;
  b.appendChild(l);
  b.scrollTop=b.scrollHeight;
  document.getElementById('debugCount').textContent=dbLines.length+' lines';
  console[lvl==='error'?'error':lvl==='warn'?'warn':'log']('[TRER]',msg);
}
const L=(m)=>dbg('log',m),Li=(m)=>dbg('info',m),Lw=(m)=>dbg('warn',m),Le=(m)=>dbg('error',m);

// ─── UTILS ──────────────────────────────────────────────────
const escHtml=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const $=id=>document.getElementById(id);

function getDomain(url){
  try{return new URL(url).hostname.replace(/^www\./,'');}catch{return url;}
}
function stripHtml(s){return s.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();}
function tokenize(s){
  return s.toLowerCase()
    .replace(/[^a-z0-9\s]/g,' ')
    .split(/\s+/)
    .filter(w=>w.length>2&&!STOPWORDS.has(w));
}
const STOPWORDS=new Set(['the','and','for','that','this','with','from','are','was','were','has','have','had','not','but','what','when','where','who','how','its','will','can','may','about','also','than','then','there','their','they','been','being','your','our','any','all','each','both','few','more','most','other','some','such','into','onto','after','before','during','without','between','through','these','those','only','just','now','new','first','last','long','great','since','per','via','vs','etc','get','use','make','like','time','need','very','well','over','even','still','back','way','take','give']);

function extractNgrams(tokens,n){
  const grams={};
  for(let i=0;i<=tokens.length-n;i++){
    const g=tokens.slice(i,i+n).join(' ');
    grams[g]=(grams[g]||0)+1;
  }
  return grams;
}

// ─── PROXY + FETCH ──────────────────────────────────────────
// Detect self-serve: if loaded from http(s), same origin can relay
const SELF_ORIGIN=(()=>{
  const p=location.protocol;
  if(p==='http:'||p==='https:') return location.origin;
  return null;
})();

// Proxy builders — tried in order per attempt
const PROXY_BUILDERS=[
  // 0: allorigins (wraps in {contents})
  u=>`https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
  // 1: corsproxy.io
  u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,
  // 2: cors-anywhere
  u=>`https://cors-anywhere.herokuapp.com/${u}`,
  // 3: thingproxy
  u=>`https://thingproxy.freeboard.io/fetch/${u}`,
  // 4: encode variant of allorigins
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
];
// If served from http(s), prepend same-origin relay as first option
// (avoids CORS entirely — server can fetch DDG without restriction)
if(SELF_ORIGIN){
  PROXY_BUILDERS.unshift(u=>`${SELF_ORIGIN}/fetch?url=${encodeURIComponent(u)}`);
}
let proxyIdx=0;
// Health tracking: proxy fail counts this run
const proxyFails={};

// Extract text content from any proxy response format
function unwrapProxyResponse(text,ct){
  if(!text)return '';
  try{
    const j=JSON.parse(text);
    if(j.contents!==undefined)return j.contents;
    if(j.body!==undefined)return j.body;
    if(j.data!==undefined)return j.data;
  }catch{}
  return text;
}

// JSONP hack for DDG instant (avoids CORS entirely for JSON API)
function fetchDDGInstantJsonp(query){
  return new Promise((res,rej)=>{
    const cb='trer_cb_'+Date.now();
    const s=document.createElement('script');
    const tid=setTimeout(()=>{
      delete window[cb];s.remove();
      rej(new Error('JSONP timeout'));
    },10000);
    window[cb]=data=>{
      clearTimeout(tid);delete window[cb];s.remove();
      res(data);
    };
    s.src=`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_redirect=1&no_html=1&skip_disambig=1&callback=${cb}`;
    s.onerror=()=>{clearTimeout(tid);delete window[cb];s.remove();rej(new Error('JSONP load error'));};
    document.head.appendChild(s);
  });
}

// Core fetch with per-attempt timeout and proxy rotation
async function fetchOnce(url,pIdx,timeoutMs=12000){
  const proxied=PROXY_BUILDERS[pIdx](url);
  Li(`fetch[p${pIdx}] ${url.slice(0,55)}…`);
  const ctrl=new AbortController();
  const tid=setTimeout(()=>ctrl.abort(),timeoutMs);
  try{
    const r=await fetch(proxied,{signal:ctrl.signal});
    clearTimeout(tid);
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const ct=r.headers.get('content-type')||'';
    const text=ct.includes('json')?JSON.stringify(await r.json()):await r.text();
    return unwrapProxyResponse(text,ct);
  }finally{clearTimeout(tid);}
}

// NGU delay state per operation
const nguState={active:false,attempt:0,delay:0};

function nguUpdateUI(text,attempt,delay,maxDelay=10000){
  const bar=$('nguBar');
  const pct=maxDelay>0?Math.round((delay/maxDelay)*100):0;
  $('nguText').textContent=text;
  $('nguAttempt').textContent=`#${attempt}`;
  $('nguDelayFill').style.width=pct+'%';
  bar.classList.toggle('show',nguState.active);
}

// Adaptive delay: grows on fail, resets on success, clamps 0–10s
function nextNguDelay(fails){
  // Fibonacci-ish growth, capped at 10s, with jitter ±200ms
  const base=Math.min(500*Math.pow(1.6,fails-1),10000);
  const jitter=(Math.random()-0.5)*400;
  return Math.max(0,Math.min(10000,Math.round(base+jitter)));
}

// Main fetch function — NGU-aware, proxy-rotating, multi-strategy
async function fetchProxy(url,opId){
  const isNgu=cfg.ngu;
  const maxRegularAttempts=cfg.retry?PROXY_BUILDERS.length*2:PROXY_BUILDERS.length;
  let totalFails=0;
  let nguFails=0;

  // eslint-disable-next-line no-constant-condition
  while(true){
    if(abortFlag||runOpId!==opId)throw new Error('Aborted');

    const pIdx=totalFails%PROXY_BUILDERS.length;

    try{
      const txt=await fetchOnce(url,pIdx);
      if(!txt||txt.length<20)throw new Error('Empty response');
      L(`OK p${pIdx} len=${txt.length}`);
      proxyIdx=pIdx;
      if(isNgu&&nguFails>0){
        nguState.active=false;nguUpdateUI('',0,0);
      }
      return txt;
    }catch(e){
      totalFails++;
      nguFails++;
      proxyFails[pIdx]=(proxyFails[pIdx]||0)+1;
      Lw(`p${pIdx} fail#${totalFails}: ${e.message}`);

      if(abortFlag||runOpId!==opId)throw new Error('Aborted');

      // Without NGU: give up after maxRegularAttempts
      if(!isNgu&&totalFails>=maxRegularAttempts){
        throw new Error(`All ${PROXY_BUILDERS.length} proxies failed`);
      }

      // NGU: keep going with adaptive delay
      const delay=isNgu?nextNguDelay(nguFails):Math.min(800*totalFails,3000);

      if(isNgu){
        nguState.active=true;nguState.attempt=nguFails;nguState.delay=delay;
        const msg=`Hunting… proxy ${(pIdx+1)%PROXY_BUILDERS.length+1}/${PROXY_BUILDERS.length} · wait ${(delay/1000).toFixed(1)}s`;
        nguUpdateUI(msg,nguFails,delay);
        statusMsg('warn',`NGU retry #${nguFails} after ${(delay/1000).toFixed(1)}s`);
      } else {
        showToast(`Retry ${totalFails}/${maxRegularAttempts}… (${e.message})`);
      }

      // Animate the delay bar countdown
      if(delay>100){
        const steps=20;const stepMs=delay/steps;
        for(let s=0;s<steps;s++){
          if(abortFlag||runOpId!==opId){nguState.active=false;throw new Error('Aborted');}
          if(isNgu) $('nguDelayFill').style.width=Math.round(((steps-s)/steps)*100)+'%';
          await sleep(stepMs);
        }
      } else {
        await sleep(delay);
      }
    }
  }
}

async function fetchDDGInstant(query,opId){
  // Try JSONP first (no CORS issue)
  try{
    const data=await fetchDDGInstantJsonp(query);
    L('DDG instant via JSONP OK');
    return data;
  }catch(e){Lw('JSONP fail: '+e.message);}

  // Fallback to proxied fetch
  const url=`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_redirect=1&no_html=1&skip_disambig=1`;
  const txt=await fetchProxy(url,opId);
  try{
    let raw=txt;
    try{const j=JSON.parse(txt);if(j.RelatedTopics!==undefined)return j;raw=j.contents||txt;}catch{}
    return JSON.parse(raw);
  }catch(e){Lw('DDG instant parse fail: '+e.message);return null;}
}

async function fetchDDGHtml(query,opId){
  const url=`https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`;
  return await fetchProxy(url,opId);
}

// ─── PARSE DDG HTML ─────────────────────────────────────────
function parseDDGHtml(html){
  const parser=new DOMParser();
  const doc=parser.parseFromString(html,'text/html');
  const results=[];
  const cards=doc.querySelectorAll('.result__body,.result,.web-result');
  cards.forEach(card=>{
    const titleEl=card.querySelector('.result__a,[data-testid="result-title-a"],h2 a');
    const snippetEl=card.querySelector('.result__snippet,[data-result="snippet"],.snippet');
    const urlEl=card.querySelector('.result__url,.result__extras__url');
    if(!titleEl)return;
    const title=titleEl.textContent.trim();
    let url=titleEl.href||'';
    // DDG redirects: extract actual URL
    if(url.includes('duckduckgo.com/l/?')){
      try{const u=new URL(url);url=decodeURIComponent(u.searchParams.get('uddg')||u.searchParams.get('u')||url);}catch{}
    }
    if(!url||url.startsWith('javascript'))return;
    const snippet=(snippetEl?.textContent||'').trim();
    const domain=getDomain(url);
    if(domain&&title)results.push({title,url,domain,snippet});
  });
  // Fallback: look for any links that look like real URLs
  if(results.length===0){
    const links=doc.querySelectorAll('a[href]');
    links.forEach(a=>{
      const href=a.href;
      if(!href||href.includes('duckduckgo.com')||href.includes('javascript'))return;
      const title=a.textContent.trim();
      if(title.length<5)return;
      try{
        const u=new URL(href);
        if(u.protocol.startsWith('http'))
          results.push({title,url:href,domain:u.hostname.replace(/^www\./,''),snippet:''});
      }catch{}
    });
  }
  L(`Parsed ${results.length} results from HTML`);
  return results.slice(0,cfg.resPerKw);
}

// ─── SEO PENALTY ────────────────────────────────────────────
const SEO_TERMS=/\b(best|top \d+|review|buy|cheap|deal|price|#1|ranked|comparison|vs\.|affiliate|sponsored|ad)\b/i;
const SPAM_DOMAINS=new Set(['amazon','pinterest','yelp','tripadvisor','trustpilot','g2.com','capterra','getapp']);
const BONUS_DOMAINS=/(\.edu|\.gov|\.ac\.|arxiv|scholar|pubmed|doi\.org)/;

function seoScore(r){
  let s=0;
  if(cfg.antiSeo){
    if(SEO_TERMS.test(r.title))s-=15;
    if(SEO_TERMS.test(r.snippet))s-=8;
    if(SPAM_DOMAINS.has(r.domain.split('.')[0]))s-=25;
    if(BONUS_DOMAINS.test(r.domain))s+=20;
    // penalize very generic titles
    if(r.title.split(' ').length<4)s-=5;
  }
  return s;
}

// ─── WAVE 1 ─────────────────────────────────────────────────
async function wave1(query,opId){
  Li('Wave 1: Expansion via DDG Instant + HTML');
  setWave(1,'active',0);
  statusMsg('info',`W1: Querying "${query}"…`);

  const termFreq={};
  const termDomains={};

  // 1a: DDG Instant API
  setWave(1,'active',20);
  const inst=await fetchDDGInstant(query,opId).catch(e=>{Lw('W1 instant: '+e.message);return null;});
  if(inst){
    const texts=[];
    (inst.RelatedTopics||[]).forEach(t=>{
      if(t.Text)texts.push(t.Text);
      (t.Topics||[]).forEach(st=>st.Text&&texts.push(st.Text));
    });
    (inst.RelatedSearches||[]).forEach(r=>r.Text&&texts.push(r.Text));
    if(inst.AbstractText)texts.push(inst.AbstractText);
    (inst.Results||[]).forEach(r=>{if(r.Text)texts.push(r.Text);});

    L(`W1 instant: ${texts.length} text sources`);
    texts.forEach(t=>{
      const toks=tokenize(t);
      const bigrams=extractNgrams(toks,2);
      const trigrams=extractNgrams(toks,3);
      Object.entries({...bigrams,...trigrams}).forEach(([g,c])=>{
        termFreq[g]=(termFreq[g]||0)+c;
        if(!termDomains[g])termDomains[g]=new Set();
        termDomains[g].add('instant_api');
      });
      toks.forEach(w=>{
        if(w.length>4){
          termFreq[w]=(termFreq[w]||0)+1;
          if(!termDomains[w])termDomains[w]=new Set();
          termDomains[w].add('instant_api');
        }
      });
    });
  }

  // 1b: DDG HTML results
  setWave(1,'active',45);
  await sleep(cfg.delay);
  const html=await fetchDDGHtml(query,opId).catch(e=>{Lw('W1 html: '+e.message);return null;});
  let htmlResults=[];
  if(html){
    htmlResults=parseDDGHtml(html);
    L(`W1 html results: ${htmlResults.length}`);
    htmlResults.forEach(r=>{
      const src=r.title+' '+r.snippet;
      const toks=tokenize(src);
      const bigrams=extractNgrams(toks,2);
      const trigrams=extractNgrams(toks,3);
      Object.entries({...bigrams,...trigrams}).forEach(([g,c])=>{
        termFreq[g]=(termFreq[g]||0)+c;
        if(!termDomains[g])termDomains[g]=new Set();
        termDomains[g].add(r.domain);
      });
    });
  }

  // Score: freq × domain_diversity
  setWave(1,'active',75);
  const qTokens=new Set(tokenize(query));
  const scored=Object.entries(termFreq)
    .filter(([g])=>{
      // must not be entirely inside query tokens
      const gToks=g.split(' ');
      return !gToks.every(t=>qTokens.has(t));
    })
    .map(([g,freq])=>{
      const div=termDomains[g]?.size||1;
      const score=freq*Math.log(1+div);
      return {term:g,freq,div,score};
    })
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score);

  // Divergence filter: remove if from single domain
  const filtered=scored.filter(x=>x.div>=1);
  const top=filtered.slice(0,cfg.maxKw);

  L(`W1 done: ${top.length} expansion terms`);
  setWave(1,'done',100);
  statusMsg('ok',`W1: ${top.length} expansion terms found`);
  return {terms:top,htmlResults};
}

// ─── WAVE 2 ─────────────────────────────────────────────────
async function wave2(query,terms,w1Results,opId){
  Li('Wave 2: Multi-query result harvest');
  setWave(2,'active',0);

  const allResults=[];
  // include original query results from W1 as "wave 2"
  w1Results.forEach(r=>allResults.push({...r,wave:1,keyword:query,waveScore:1}));

  const total=terms.length;
  for(let i=0;i<terms.length;i++){
    if(abortFlag||runOpId!==opId)break;
    const t=terms[i];
    const q=`${query} ${t.term}`;
    statusMsg('info',`W2 [${i+1}/${total}]: "${t.term}"`);
    setWave(2,'active',Math.round(((i+0.5)/total)*100));

    await sleep(cfg.delay);
    const html=await fetchDDGHtml(q,opId).catch(e=>{
      Lw(`W2 query fail: ${e.message}`);
      return null;
    });
    if(html){
      const res=parseDDGHtml(html);
      res.forEach(r=>allResults.push({...r,wave:2,keyword:t.term,termScore:t.score,waveScore:2}));
      L(`W2[${i+1}] "${t.term}" → ${res.length} results`);
    }
    setWave(2,'active',Math.round(((i+1)/total)*100));
  }

  setWave(2,'done',100);
  statusMsg('ok',`W2: ${allResults.length} raw results collected`);
  L(`W2 done: ${allResults.length} results`);
  return allResults;
}

// ─── WAVE 3 ─────────────────────────────────────────────────
function wave3(query,allResults){
  Li('Wave 3: Cross-wave scoring & deduplication');
  setWave(3,'active',10);
  statusMsg('info','W3: Computing relevance scores…');

  const qToks=new Set(tokenize(query));

  // Group by URL
  const urlMap={};
  allResults.forEach(r=>{
    const key=r.url;
    if(!urlMap[key]){urlMap[key]={...r,appearances:0,waves:new Set(),keywords:new Set(),totalTermScore:0};}
    const m=urlMap[key];
    m.appearances++;
    m.waves.add(r.wave);
    m.keywords.add(r.keyword||query);
    m.totalTermScore+=(r.termScore||0);
  });

  setWave(3,'active',40);

  // Score each URL
  const scored=Object.values(urlMap).map(r=>{
    let score=0;

    // Appearance bonus (log scale)
    score+=Math.log(1+r.appearances)*25;

    // Wave diversity (appeared in multiple waves)
    score+=r.waves.size*20;

    // Keyword diversity (matched across many keywords)
    score+=r.keywords.size*15;

    // Content similarity to query
    const contentToks=tokenize(r.title+' '+r.snippet);
    const overlap=contentToks.filter(t=>qToks.has(t)).length;
    const sim=qToks.size>0?overlap/qToks.size:0;
    score+=sim*30;

    // Term score contribution
    score+=Math.min(r.totalTermScore/10,20);

    // SEO adjustment
    score+=seoScore(r);

    // Domain diversity: penalize if same domain appears too much
    const domainCount=Object.values(urlMap).filter(x=>x.domain===r.domain).length;
    if(cfg.diversity&&domainCount>2)score-=(domainCount-2)*8;

    return {...r,score:Math.round(score),sim:Math.round(sim*100)};
  });

  setWave(3,'active',75);

  // Sort and dedupe domains if diversity on
  scored.sort((a,b)=>b.score-a.score);

  let final=scored;
  if(cfg.diversity){
    const seenDomains={};
    final=scored.filter(r=>{
      const d=r.domain;
      seenDomains[d]=(seenDomains[d]||0)+1;
      return seenDomains[d]<=2; // max 2 per domain
    });
  }

  setWave(3,'done',100);
  statusMsg('ok',`W3: Top ${Math.min(final.length,cfg.topN)} results finalized`);
  L(`W3 done: ${final.length} unique scored results`);
  return final.slice(0,cfg.topN);
}

// ─── MAIN RUN ───────────────────────────────────────────────
async function runSearch(){
  const query=$('qInput').value.trim();
  if(!query||running)return;

  // Mint new operation ID — any stale NGU loops from prior run will bail on opId check
  const opId=++runOpId;

  running=true;abortFlag=false;
  nguState.active=false;
  $('nguBar').classList.remove('show');
  $('runBtn').disabled=true;
  $('runBtn').innerHTML='<span class="pulsing">■</span> STOP';
  $('runBtn').onclick=()=>{abortFlag=true;};

  $('waveTrack').classList.add('show');
  $('statusLog').classList.add('show');
  $('statusLog').innerHTML='';
  $('kwSection').classList.remove('show');
  $('resultsSection').classList.remove('show');
  $('emptyState').style.display='none';
  $('topStatus').style.display='inline';

  // Reset waves
  ['w1','w2','w3'].forEach(w=>{
    $(w+'fill').style.width='0';
    $(w+'fill').className=`wave-fill${w==='w2'?' w2':w==='w3'?' w3':''}`;
    $(w+'lbl').className='wave-lbl';
    $(w+'stat').textContent='';
  });

  // Timer
  elapsed=0;
  clearInterval(elapsedTimer);
  elapsedTimer=setInterval(()=>{
    elapsed++;
    $('elapsedLbl').textContent=elapsed+'s';
  },1000);

  $('etaLbl').textContent='Starting Wave 1…';
  Li(`=== Search: "${query}" (op#${opId}) ===`);
  if(cfg.ngu) Li('No-Give-Up mode ACTIVE — will hunt until found');

  try{
    // WAVE 1
    const {terms,htmlResults}=await wave1(query,opId);
    if(runOpId!==opId)return; // stale run
    showKeywords(query,terms);

    if(abortFlag||runOpId!==opId)throw new Error('Aborted by user');

    // WAVE 2
    $('etaLbl').textContent='Wave 2: Expanding queries…';
    const allResults=await wave2(query,terms,htmlResults,opId);
    if(runOpId!==opId)return;

    if(abortFlag||runOpId!==opId)throw new Error('Aborted by user');

    // WAVE 3
    $('etaLbl').textContent='Wave 3: Scoring…';
    const final=wave3(query,allResults);

    lastResults=final;
    renderResults(final,query);
    saveHistory(query,final.length);
    $('etaLbl').textContent=`Done · ${final.length} results · ${elapsed}s`;

  }catch(e){
    Le('Run error: '+e.message);
    if(runOpId!==opId)return; // stale, ignore
    statusMsg('err','Error: '+e.message);
    $('etaLbl').textContent='Failed — '+e.message;
    if(!abortFlag)showToast('Search failed. Check debug.');
    $('emptyState').style.display='block';
    $('emptyState').querySelector('.empty-icon').textContent='⚠';
    $('emptyState').querySelector('.empty-title').textContent='Search Error';
    $('emptyState').querySelector('.empty-sub').textContent=e.message+'\nProxy unavailable. Try again or enable No-Give-Up.';
  }finally{
    if(runOpId===opId){
      running=false;
      nguState.active=false;
      $('nguBar').classList.remove('show');
      clearInterval(elapsedTimer);
      $('runBtn').disabled=false;
      $('runBtn').innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> RUN';
      $('runBtn').onclick=runSearch;
    }
  }
}

// ─── UI HELPERS ─────────────────────────────────────────────
function setWave(n,state,pct){
  const lbl=$(`w${n}lbl`),fill=$(`w${n}fill`),stat=$(`w${n}stat`);
  lbl.className='wave-lbl '+(state==='done'?'done':'active');
  fill.style.width=pct+'%';
  if(state==='done'){
    fill.classList.add('done');
    stat.textContent='✓';
  } else {
    stat.textContent=pct+'%';
  }
}

function statusMsg(type,msg){
  const log=$('statusLog');
  const ts=new Date().toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const el=document.createElement('div');
  el.className=`status-entry ${type==='ok'?'ok':type==='err'?'err':type==='warn'?'warn':'info'}`;
  el.innerHTML=`<span class="ts">${ts}</span><span class="msg">${escHtml(msg)}</span>`;
  log.appendChild(el);
  log.scrollTop=log.scrollHeight;
  $('topStatus').textContent=msg.slice(0,40)+(msg.length>40?'…':'');
}

function showKeywords(query,terms){
  const chips=$('kwChips');
  chips.innerHTML='';

  // Original query chip
  const oc=document.createElement('div');
  oc.className='chip kw-orig';
  oc.innerHTML=`<span>${escHtml(query)}</span><span class="chip-score">QUERY</span>`;
  chips.appendChild(oc);

  terms.forEach((t,i)=>{
    const c=document.createElement('div');
    const cls=i<3?'kw-hi':i<6?'kw-md':'kw-lo';
    c.className=`chip ${cls}`;
    c.innerHTML=`<span>${escHtml(t.term)}</span><span class="chip-score">${t.score.toFixed(1)}</span>`;
    chips.appendChild(c);
  });

  $('kwSection').classList.add('show');
  $('waveTrack').querySelector('.wave-stat').textContent;
  $(`w1stat`).textContent=`${terms.length}kw`;
}

function renderResults(results,query){
  const list=$('resultsList');
  list.innerHTML='';

  if(!results.length){
    $('emptyState').style.display='block';
    $('emptyState').querySelector('.empty-icon').textContent='○';
    $('emptyState').querySelector('.empty-title').textContent='No results found';
    $('emptyState').querySelector('.empty-sub').textContent='Try a different query or check your connection.';
    return;
  }

  $('resultsSection').classList.add('show');
  $('resultCount').querySelector('span').textContent=`${results.length} results`;

  results.forEach((r,i)=>{
    const card=document.createElement('a');
    card.className='result-card';
    card.href=r.url;
    card.target='_blank';
    card.rel='noopener noreferrer';

    const rankCls=i<3?'rc-rank top3':'rc-rank';
    const waveStr=[...r.waves].sort().map(w=>`W${w}`).join('+');
    const kwStr=[...r.keywords].slice(0,2).join(', ');

    card.innerHTML=`
      <div class="${rankCls}">#${i+1}</div>
      <div class="rc-title">${escHtml(r.title)}</div>
      <div class="rc-url">${escHtml(r.domain)}</div>
      ${r.snippet?`<div class="rc-snippet">${escHtml(r.snippet.slice(0,140))}${r.snippet.length>140?'…':''}</div>`:''}
      <div class="rc-meta">
        <span class="rc-badge score">⬆ ${r.score}</span>
        <span class="rc-badge waves">${escHtml(waveStr)}</span>
        <span class="rc-badge domain">${escHtml(r.domain.split('.')[0])}</span>
      </div>`;
    list.appendChild(card);
  });

  $(`w2stat`).textContent=results.length+'u';
  $(`w3stat`).textContent='TOP '+results.length;
}

function showToast(msg,dur=3000){
  const t=$('toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}

// ─── SORT ───────────────────────────────────────────────────
$('sortLbl').onclick=function(){
  if(!lastResults.length)return;
  sortMode=sortMode==='relevance'?'domain':'relevance';
  this.textContent=sortMode==='relevance'?'↓ relevance':'↓ domain';
  const sorted=sortMode==='relevance'
    ?[...lastResults].sort((a,b)=>b.score-a.score)
    :[...lastResults].sort((a,b)=>a.domain.localeCompare(b.domain));
  renderResults(sorted,$('qInput').value.trim());
};

// ─── HISTORY ────────────────────────────────────────────────
function saveHistory(query,count){
  histArr.unshift({q:query,count,ts:Date.now()});
  histArr=histArr.slice(0,20);
  try{localStorage.setItem(HIST_KEY,JSON.stringify(histArr));}catch{}
}
function loadHistory(){
  try{const s=localStorage.getItem(HIST_KEY);if(s)histArr=JSON.parse(s);}catch{}
}
function renderHistory(){
  const body=$('historyBody');
  body.innerHTML='';
  if(!histArr.length){
    body.innerHTML='<div class="empty-state" style="padding:20px 0"><div class="empty-icon">⏱</div><div class="empty-sub">No searches yet</div></div>';
    return;
  }
  histArr.forEach((h,i)=>{
    const el=document.createElement('div');
    el.className='hist-item';
    const dt=new Date(h.ts).toLocaleDateString('en',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    el.innerHTML=`<span class="hist-q">${escHtml(h.q)}</span><span class="hist-meta">${h.count} results · ${dt}</span><button class="hist-del" data-i="${i}">✕</button>`;
    el.onclick=e=>{
      if(e.target.classList.contains('hist-del'))return;
      $('qInput').value=h.q;
      closeDrawer('history');
      runSearch();
    };
    body.appendChild(el);
  });
  body.querySelectorAll('.hist-del').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      histArr.splice(+btn.dataset.i,1);
      try{localStorage.setItem(HIST_KEY,JSON.stringify(histArr));}catch{}
      renderHistory();
    };
  });
}

// ─── SETTINGS ───────────────────────────────────────────────
function saveCfg(){
  try{localStorage.setItem(CFG_KEY,JSON.stringify(cfg));}catch{}
}
function loadCfg(){
  try{const s=localStorage.getItem(CFG_KEY);if(s)Object.assign(cfg,JSON.parse(s));}catch{}
  $('cfgMaxKw').value=cfg.maxKw;
  $('cfgResPerKw').value=cfg.resPerKw;
  $('cfgTopN').value=cfg.topN;
  $('cfgDelay').value=cfg.delay;
  setToggle('cfgAntiSeo',cfg.antiSeo);
  setToggle('cfgDiversity',cfg.diversity);
  setToggle('cfgRetry',cfg.retry);
  setToggle('cfgNgu',cfg.ngu);
}
function setToggle(id,val){
  const el=$(id);
  el.classList.toggle('on',!!val);
  el.dataset.val=val?'1':'0';
}
const TOGGLE_MAP={cfgAntiSeo:'antiSeo',cfgDiversity:'diversity',cfgRetry:'retry',cfgNgu:'ngu'};
['cfgAntiSeo','cfgDiversity','cfgRetry','cfgNgu'].forEach(id=>{
  $(id).onclick=function(){
    const v=this.dataset.val!=='1';
    setToggle(id,v);
    cfg[TOGGLE_MAP[id]]=v;
    saveCfg();
  };
});
['cfgMaxKw','cfgResPerKw','cfgTopN','cfgDelay'].forEach(id=>{
  $(id).onchange=function(){
    const map={cfgMaxKw:'maxKw',cfgResPerKw:'resPerKw',cfgTopN:'topN',cfgDelay:'delay'};
    cfg[map[id]]=+this.value;
    saveCfg();
  };
});

// ─── DRAWER ─────────────────────────────────────────────────
function openDrawer(name){
  $(`${name}Overlay`).classList.add('open');
  $(`${name}Drawer`).classList.add('open');
  document.body.style.overflow='hidden';
}
function closeDrawer(name){
  $(`${name}Overlay`).classList.remove('open');
  $(`${name}Drawer`).classList.remove('open');
  document.body.style.overflow='';
}
['settings','history','debug','changelog'].forEach(name=>{
  $(`${name}Overlay`).onclick=()=>closeDrawer(name);
  $(`${name}Close`).onclick=()=>closeDrawer(name);
});
$('btnSettings').onclick=()=>{loadCfg();openDrawer('settings');};
$('btnHistory').onclick=()=>{renderHistory();openDrawer('history');};
$('openDebug').onclick=()=>{closeDrawer('settings');openDrawer('debug');};
$('openChangelog').onclick=()=>{renderChangelog();closeDrawer('settings');openDrawer('changelog');};
$('clearHistory').onclick=()=>{
  histArr=[];
  try{localStorage.removeItem(HIST_KEY);}catch{}
  showToast('History cleared');
  closeDrawer('settings');
};
$('clearDebug').onclick=()=>{
  dbLines.length=0;
  $('debugBody').innerHTML='';
  $('debugCount').textContent='0 lines';
};
$('exportDebug').onclick=()=>{
  const txt=dbLines.map(l=>`[${l.ts}] ${l.lvl.toUpperCase()} ${l.msg}`).join('\n');
  const b=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(b);
  a.download=`trer-debug-${Date.now()}.txt`;
  a.click();
};

// ─── CHANGELOG ──────────────────────────────────────────────
function renderChangelog(){
  const list=$('changelogList');
  list.innerHTML='';
  CHANGELOG.forEach(c=>{
    const el=document.createElement('div');
    el.className='cl-ver';
    el.innerHTML=`
      <div class="cl-ver-head">
        <span class="cl-ver-num">v${c.v}</span>
        <span class="cl-ver-date">${c.date}</span>
        <div class="cl-diff" style="margin-left:auto">
          <span class="cl-add">${c.add}</span>
          <span class="cl-rem">${c.rem}</span>
        </div>
      </div>
      <div class="cl-notes">${escHtml(c.notes)}</div>`;
    list.appendChild(el);
  });
}

// ─── RUN BUTTON ─────────────────────────────────────────────
$('runBtn').onclick=runSearch;
$('qInput').onkeydown=e=>{if(e.key==='Enter')runSearch();};

// ─── INIT ───────────────────────────────────────────────────
loadCfg();
loadHistory();
L('TRER v'+VER+' init');
Li('Three-Wave Semantic Resolver ready');
if(SELF_ORIGIN){Li('Self-serve relay active: '+SELF_ORIGIN);L('Proxy count: '+PROXY_BUILDERS.length+' (relay at idx 0)');}
else L('file:// mode — using public CORS proxies ('+PROXY_BUILDERS.length+')');
</script>
</body>
</html>
